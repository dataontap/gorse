<!DOCTYPE html>
<html>
<head>
    <title>dot Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="/static/help-styles.css">

    <!-- Firebase v9+ modular SDK -->
    <script type="module" src="/static/firebase-init.js"></script>
    <script type="module" src="/static/firebase-auth.js"></script>

    <style>

        .esim-info {
            display: none;
            position: absolute;
            background-color: #fff;
            border: 1px solid #ccc;
            padding: 10px;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 10;
        }

        .esim-icon:hover + .esim-info {
            display: block;
        }

        .name-with-esim {
            position: relative;
            display: inline-block;
        }
        .paused {
            background-color: #f2f2f2; /* Grey background for paused cards */
        }
        .paused .pause-duration {
            margin-left: 10px; /* Adjust spacing as needed */
        }
        .fa-play {
            color: #007bff; /* Make play button more distinct */
        }
        .online-indicator {
            width: 10px;
            height: 10px;
            background-color: yellow;
            border-radius: 50%;
            margin-right: 5px;
            animation: pulse 1s ease-in-out infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.2);
                opacity: 0.5;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .subscription-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            color: white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
            word-wrap: break-word;
            text-align: left;
        }

        .subscription-card h3 {
            margin: 0 0 15px 0;
            font-size: 2.2em;
            font-weight: bold;
            white-space: normal;
            word-wrap: break-word;
            line-height: 1.2;
        }

        .subscription-card p {
            margin: 0 0 10px 0;
            font-size: 1.1em;
            opacity: 0.9;
            line-height: 1.5;
            white-space: normal;
            word-wrap: break-word;
            max-width: 100%;
        }

        .subscribe-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 12px 25px;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            margin-top: 15px;
            white-space: nowrap;
            overflow: visible;
            text-overflow: clip;
            min-width: fit-content;
        }

        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            box-sizing: border-box;
            overflow-x: hidden;
        }

        @media (max-width: 768px) {
            .dashboard-container {
                padding: 10px;
            }

            .subscription-card {
                padding: 20px;
                margin: 10px 0;
            }

            .subscription-card h3 {
                font-size: 1.8em;
            }

            .subscription-card p {
                font-size: 1em;
            }
        }

    </style>
</head>
<body class="landing-page">
    <div class="top-bar">
        <div class="menu-icon" onclick="toggleMenu(this)">
            <i class="fas fa-bars"></i>
            <div class="menu-dropdown">
                <a href="/dashboard"><i class="fas fa-database"></i> Data</a>
                <a href="/network"><i class="fas fa-network-wired"></i> Network</a>
                <a href="/marketplace"><i class="fas fa-store"></i> Marketplace</a>
                <a href="/notifications"><i class="fas fa-bell"></i> Notifications</a>
            </div>
        </div>
        <div class="profile-section">
            <i class="fas fa-user-circle" onclick="toggleProfileDropdown()"></i>
            <div class="profile-dropdown">
                <div class="profile-info">
                    <div class="profile-header">
                        <span class="account-text">My Account</span>
                        <i class="fas fa-qrcode qr-code-icon" onclick="toggleQRCode(event)"></i>
                    </div>
                    <div class="wallet-pill-container">
                        <a href="/payments" class="wallet-value-pill">100 DOTM = $100.00</a>
                    </div>
                    <div id="qrCodePopup" class="qr-code-popup">
                        <div id="qrcode"></div>
                        <p id="qrMemberCount" class="member-count-qr">#1/X</p>
                        <p>Scan to link accounts</p>
                    </div>
                </div>
                <a href="/profile"><i class="fas fa-user"></i> Profile</a>
                <a href="#"><i class="fas fa-shopping-cart"></i> Orders</a>
                <a href="/payments"><i class="fas fa-credit-card"></i> Payments</a>
                <a href="#" id="settingsToggle"><i class="fas fa-cog"></i> Settings</a>
                <div class="settings-submenu" style="display: none;">
                    <a href="#" id="darkModeToggle"><i class="fas fa-moon"></i> <span>Dark Mode</span></a>
                </div>
                <a href="/" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a>
                <a href="#" id="helpToggle">
                    <i class="fas fa-question-circle"></i> <span id="helpText">Help</span>
                    <i id="helpPhoneIcon" class="fas fa-phone" style="display: none; margin-left: 8px;"></i>
                </a>
                <div class="help-section" style="display: none;">
                    <div class="help-content">
                        <p><i class="fas fa-question-circle"></i> Talk to AI instead:</p>
                        <ul>
                            <li style="display: flex; align-items: center;">
                                <span class="online-indicator chatgpt-indicator"></span>
                                <a href="https://chat.openai.com" class="help-link" target="_blank">ChatGPT</a>
                            </li>
                            <li style="display: flex; align-items: center;">
                                <span class="online-indicator gemini-indicator"></span>
                                <a href="https://gemini.google.com" class="help-link" target="_blank">Google Gemini</a>
                            </li>
                        </ul>
                        <p class="help-note">LLMs goto mcp.dotmobile.app</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="container">
        <div class="dot-container">
            <div class="dot-indicator" title="Long press to refresh">
                <div class="dot-content">
                    <div class="data-amount" id="dataDisplay" style="display: none">
                        <i class="fas fa-sync-alt refresh-icon" title="Loading data..."></i><span>GB</span>
                    </div>
                    <div class="status" id="globalStatus" style="display: none"><i class="fas fa-globe"></i> Global</div>
                </div>
            </div>
        </div>
        <div class="offers-content-box">
            <div id="promotionsCarousel" class="carousel slide" data-bs-touch="true">
                <div class="carousel-inner">
                    <div class="carousel-item active">
                        <div class="offer-card">
                            <div class="offer-content">
                                <h3>Global Priority Data</h3>
                                <p>10GB no-expiry data for $10.</p>
                                <p>Share with any member.</p>
                                <p>Works in 160+ countries.</p>
                                <button class="btn btn-primary" onclick="showConfirmationDrawer(10, 10, 'global_data_10gb')">Buy</button>
                            </div>
                        </div>
                    </div>
                    <div class="carousel-item">
                        <div class="offer-card">
                            <div class="offer-content">
                                <h3>Full Membership</h3>
                                <p>Global Data Access. National Talk + Text.</p>
                                <p>Global Wi-Fi Calling & Satellite eTXT.</p>
                                <p><strong>$66/year</strong></p>
                                <button class="btn btn-secondary" disabled onclick="sendComingSoonNotification()">Subscribe</button>
                            </div>
                        </div>
                    </div>
                    <div class="carousel-item">
                        <div class="offer-card">
                            <div class="offer-content">
                                <h3>Basic Membership</h3>
                                <p>New number. 2FA. Global data access.</p>
                                <p>To include SAT T9-1-1 when available.</p>
                                <p><strong>$24/year</strong></p>
                                <button class="btn btn-primary" onclick="showConfirmationDrawer(10, 24, 'basic_membership')">Subscribe</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="carousel-controls">
                    <button type="button" data-bs-target="#promotionsCarousel" data-bs-slide-to="0" class="active" onclick="setActiveCarouselItem(0)"></button>
                    <button type="button" data-bs-target="#promotionsCarousel" data-bs-slide-to="1" onclick="setActiveCarouselItem(1)"></button>
                    <button type="button" data-bs-target="#promotionsCarousel" data-bs-slide-to="2" onclick="setActiveCarouselItem(2)"></button>
                </div>
            </div>
        </div>

        <div id="confirmationDrawer" class="confirmation-drawer">
            <div class="drawer-content">
                <h3>Confirm Purchase</h3>
                <div class="purchase-details">
                    <div class="detail-row">
                        <span>Data Amount:</span>
                        <span id="confirmDataAmount">10GB</span>
                    </div>
                    <div class="detail-row">
                        <span>Price:</span>
                        <span id="confirmPrice">$10</span>
                    </div>
                    <div class="detail-row">
                        <span>Payment Method:</span>
                        <span>Visa •••• 4242</span>
                    </div>
                </div>
                <div class="drawer-actions">

                    <div class="setting-item">
                        <div class="setting-title">Push Notifications</div>
                        <div class="setting-toggle">
                            <label class="switch">
                                <input type="checkbox" id="notificationToggle" checked>
                                <span class="slider round"></span>
                            </label>
                        </div>
                        <div class="setting-description">
                            Receive notifications about new offers and account updates
                        </div>
                    </div>

                    <button class="btn" onclick="hideConfirmationDrawer()">Cancel</button>
                    <button class="btn btn-primary" onclick="confirmPurchase()">Confirm</button>
                </div>
            </div>
        </div>

        <div class="section-header">
            <h2><i class="fas fa-exclamation-triangle"></i> Alerts</h2>
        </div>
        <div class="dashboard-content mb-4">
            <div class="purchase-history">
                <h3 class="insight-title" style="text-align: center; display: flex; justify-content: center; width: 100%;"><i class="fas fa-receipt" style="margin-right: 8px;"></i> Recent Purchases</h3>
                <div class="purchase-list" id="purchaseList">
                    <!-- Purchase items will be added here dynamically -->
                    <div class="purchase-empty-state">No purchases yet</div>
                </div>
            </div>
        </div>
        <div class="dashboard-content">
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<div class="insights-card">
                <div class="data-usage">
                    <div class="usage-header centered-header">
                        <div class="usage-label trend-alert text-center w-100"><i class="fas fa-exclamation-triangle"></i> Usage Trend Alert</div>
                    </div>
                    <div class="insight-message">Jenny's data usage increased by 45% this week. <a href="#" class="insight-link" onclick="toggleChart(this)">See details</a></div>
                    <div class="usage-chart" style="display: none;">
                        <canvas width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="sort-container">
            <h2 class="authorized-users-title">
                <i class="fas fa-users"></i> Users
                <span class="user-count">0</span>
            </h2>
            <div class="subscription-status" id="subscriptionStatus" style="display: none;">
                <div class="subscription-info">
                    <span class="subscription-type" id="subscriptionType"></span>
                    <span class="subscription-validity" id="subscriptionValidity"></span>
                </div>
            </div>
            <div class="sort-controls">
                <div class="sort-group">
                    <select class="sort-select">
                        <option value="percentage">Data</option>
                        <option value="screentime">Time</option>
                        <option value="dollars">Cost</option>
                    </select>
                </div>
                <div class="sort-icons">
                    <span class="sort-icon" data-sort="newest">
                        <i class="fas fa-clock"></i>
                        <i class="fas fa-arrow-down"></i>
                    </span>
                    <span class="sort-icon" data-sort="oldest">
                        <i class="fas fa-clock"></i>
                        <i class="fas fa-arrow-up"></i>
                    </span>
                    <span class="sort-icon" data-sort="desc">
                        <i class="fas fa-arrow-down"></i>
                    </span>
                    <span class="sort-icon" data-sort="asc">
                        <i class="fas fa-arrow-up"></i>
                    </span>
                </div>
            </div>
        </div>
        <div class="back-to-top">
            <a href="#" id="backToTop">
                Back to Top
            </a>
        </div>
        <!-- Recent Invitations Section -->
        <div class="recent-invitations-section" id="recentInvitationsSection" style="display: none;">
            <h3 class="section-title">
                <i class="fas fa-envelope"></i> Recent Invitations
            </h3>
            <div class="invitations-list" id="invitationsList">
                <!-- Invitations will be populated here by JavaScript -->
            </div>
        </div>

        <!-- User Cards for Accepted Invitations -->
        <div class="accepted-users-container" id="acceptedUsersContainer">
            <!-- Accepted invitation user cards will appear here -->
        </div>

        <div class="add-user-container">
            <a href="#" class="add-user-link" id="addUserBtn">
                <i class="fas fa-plus-circle"></i> Add User
            </a>
        </div>
        <!-- Beta Tester Toggle -->
        <div class="beta-tester-card">
            <h3>🧪 Beta Tester Program</h3>
            <p>Gorse Demo Mode

This is dotmobile V3 'gorse release' demo. We are not quite ready to start the service publicly in Canada using national networks due to Full MVNO access unavailability (read more here) (link to About). But you can opt in right here with risk of things still being in Alfa and we will send you a free eSIM to use globally. Founding members do not pay for any membership fees for life or the year 2099. They also get 100.33 DOTM ERC-20 ETH token. Every 10000MB purchase gets you 1.33DOTM. Same goes for store and anything DOT earns from Stripe registered Payment method with DOT. Every DOTM is valid $1 at dotmobile ecosystem. Only 10,333,333 DOTM will be minted or so our first blockchain contract says (link to Etherscan) and your brand new ETH wallet provided by Infura and MetaMask (links to both companies).</p>
            <div class="toggle-container">
                <label class="toggle-switch">
                    <input type="checkbox" id="betaTesterToggle">
                    <span class="toggle-slider"></span>
                </label>
                <span id="betaTesterStatus">Loading...</span>
            </div>
            <div id="betaTesterInfo" style="display: none;">
                <p><small>Connected to GitHub: <span id="githubUser">Not connected</span></small></p>
                <button id="connectGitHub" class="secondary-button">Connect GitHub</button>
            </div>
        </div>

        <!-- Service Information -->
        <div class="canada-service" style="text-align: center; margin: 40px 0 20px 0;">
            <p style="color: white; font-size: 14px; margin: 20px 0 10px 0;">
                Connectivity Services for Canadians Everywhere 🇨🇦
            </p>
            <p style="margin: 0; line-height: 1.4; color: white; font-size: 12px;">
                Service Provided by Data On Tap Inc. Licensed Full MVNO. Network 302 100.<br>Parkdale, ON, CANADA
            </p>
        </div>
    </div>
                </div>

                
            </div>
        </main>

        <!-- Confirmation Drawer -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="/static/app.js"></script>
    <script>
        // Load user data and display data balance
        document.addEventListener('DOMContentLoaded', function() {
            loadUserDataBalance();
            loadMemberCount();
            loadSubscriptionStatus();
        });

        var dataBalanceValue = 0;
        var isShowingDays = false;
        var alternatingInterval;

        function loadUserDataBalance() {
            var firebaseUid = localStorage.getItem('userId');
            if (firebaseUid) {
                fetch('/api/user/data-balance?firebaseUid=' + firebaseUid)
                    .then(response => response.json())
                    .then(data => {
                        console.log('User data balance:', data);
                        var dataDisplay = document.getElementById('dataDisplay');
                        var globalStatus = document.getElementById('globalStatus');

                        if (dataDisplay && data.dataBalance !== undefined) {
                            dataBalanceValue = data.dataBalance;
                            updateDataDisplay();
                            dataDisplay.style.display = 'block';

                            // Start alternating display
                            startAlternatingDisplay();
                        }

                        if (globalStatus) {
                            globalStatus.style.display = 'block';
                        }
                    })
                    .catch(error => {
                        console.error('Error loading data balance:', error);
                        // Show default values
                        var dataDisplay = document.getElementById('dataDisplay');
                        var globalStatus = document.getElementById('globalStatus');

                        if (dataDisplay) {
                            dataBalanceValue = 0;
                            updateDataDisplay();
                            dataDisplay.style.display = 'block';
                            startAlternatingDisplay();
                        }

                        if (globalStatus) {
                            globalStatus.style.display = 'block';
                        }
                    });
            }
        }

        function formatNumber(num) {
            return Math.floor(num).toString();
        }

        function updateDataDisplay() {
            var dataDisplay = document.getElementById('dataDisplay');
            if (!dataDisplay) return;

            if (isShowingDays) {
                // Calculate days based on 500MB per day
                var totalMB = dataBalanceValue * 1000; // Convert GB to MB
                var days = Math.floor(totalMB / 500);
                dataDisplay.innerHTML = '<span class="main-number">' + days + '</span><span class="unit">days</span>';
            } else {
                var totalMB = dataBalanceValue * 1000; // Convert GB to MB

                if (totalMB <= 1000) {
                    // Show as XXXXMB for 1000MB or less
                    var mainNumber = Math.floor(totalMB).toString();
                    dataDisplay.innerHTML = '<span class="main-number">' + mainNumber + '</span><span class="unit">MB</span>';
                } else {
                    // Show as X.XXXGB for amounts greater than 1000MB
                    var gb = totalMB / 1000;
                    var wholeGB = Math.floor(gb);
                    var decimalPart = Math.floor((gb - wholeGB) * 1000).toString().padStart(3, '0');

                    dataDisplay.innerHTML = '<span class="main-number">' + wholeGB + '</span><span class="decimal-part">.' + decimalPart + '</span><span class="unit">GB</span>';
                }
            }
        }

        function startAlternatingDisplay() {
            if (alternatingInterval) {
                clearInterval(alternatingInterval);
            }

            alternatingInterval = setInterval(function() {
                isShowingDays = !isShowingDays;
                updateDataDisplay();
            }, 10000);
        }

        function loadMemberCount() {
            fetch('/api/member-count')
                .then(response => response.json())
                .then(data => {
                    var userCountElement = document.querySelector('.user-count');
                    if (userCountElement && data.count) {
                        userCountElement.textContent = data.count;
                    }

                    // Update QR code member count
                    var qrMemberCount = document.getElementById('qrMemberCount');
                    if (qrMemberCount && data.count) {
                        qrMemberCount.textContent = '#' + data.count + '/∞';
                    }
                })
                .catch(error => {
                    console.error('Error loading member count:', error);
                });
        }

        function loadSubscriptionStatus() {
            var firebaseUid = localStorage.getItem('userId');
            if (firebaseUid) {
                fetch('/api/subscription-status?firebaseUid=' + firebaseUid)
                    .then(response => response.json())
                    .then(data => {
                        console.log('Subscription status:', data);
                        var subscriptionStatus = document.getElementById('subscriptionStatus');
                        var subscriptionType = document.getElementById('subscriptionType');
                        var subscriptionValidity = document.getElementById('subscriptionValidity');

                        if (subscriptionStatus && data.status === 'active') {
                            subscriptionStatus.style.display = 'block';
                            if (subscriptionType) {
                                if (data.subscription_type === 'basic_membership') {
                                    subscriptionType.textContent = 'Member';
                                } else {
                                    subscriptionType.textContent = data.subscription_type.replace('_', ' ').toUpperCase();
                                }
                            }
                            if (subscriptionValidity && data.end_date) {
                                var endDate = new Date(data.end_date);
                                subscriptionValidity.textContent = 'Valid until ' + endDate.toLocaleDateString();
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error loading subscription status:', error);
                    });
            }
        }

        function toggleQRCode(event) {
            event.stopPropagation();
            const popup = document.getElementById('qrCodePopup');

            if (popup.style.display === 'block') {
                popup.style.display = 'none';
            } else {
                popup.style.display = 'block';

                // Generate QR code if it doesn't exist yet
                if (!document.querySelector('#qrcode canvas')) {
                    new QRCode(document.getElementById("qrcode"), {
                        text: "https://gorse.dotmobile.app",
                        width: 150,
                        height: 150,
                        colorDark: "#333333",
                        colorLight: "#ffffff",
                        correctLevel: QRCode.CorrectLevel.H
                    });
                }
            }
        }

        function generateRandomLinkCode() {
            return Math.random().toString(36).substring(2, 12);
        }

        // Close QR code popup when clicking outside
        document.addEventListener('click', function(e) {
            const popup = document.getElementById('qrCodePopup');
            const icon = document.querySelector('.qr-code-icon');

            if (popup && popup.style.display === 'block' && !popup.contains(e.target) && e.target !== icon) {
                popup.style.display = 'none';
            }
        });
    </script>
</body>
</html>