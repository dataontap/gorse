<!DOCTYPE html>
<html>
<head>
    <title>dot Payments</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.css" rel="stylesheet">
    <link href="/static/style.css" rel="stylesheet">
</head>
<body class="dashboard-body">
    <div class="top-bar">
        <div class="menu-icon">
            <i class="fas fa-bars"></i>
            <div class="menu-dropdown">
                <a href="/dashboard"><i class="fas fa-database"></i> Data</a>
                <a href="#"><i class="fas fa-network-wired"></i> Network</a>
                <a href="/marketplace"><i class="fas fa-store"></i> Marketplace</a>
            </div>
        </div>
        <div class="profile-section">
            <i class="fas fa-user-circle"></i>
            <div class="profile-dropdown">
                <div class="profile-info">
                    My Account 
                    <i class="fas fa-qrcode qr-code-icon" onclick="toggleQRCode(event)"></i>
                    <a href="/payments" class="wallet-value-pill">$10,000.00 USD</a>
                    <div id="qrCodePopup" class="qr-code-popup">
                        <div id="qrcode"></div>
                        <p>Scan to link accounts</p>
                    </div>
                </div>
                <a href="/profile"><i class="fas fa-user"></i> Profile</a>
                <a href="#"><i class="fas fa-shopping-cart"></i> Orders</a>
                <a href="/payments" class="active"><i class="fas fa-credit-card"></i> Payments</a>
                <a href="#" id="settingsToggle"><i class="fas fa-cog"></i> Settings</a>
                <div class="settings-submenu" style="display: none;">
                    <a href="#" id="darkModeToggle"><i class="fas fa-moon"></i> <span>Dark Mode</span></a>
                </div>
                <a href="#" id="helpToggle">
                    <i class="fas fa-question-circle"></i> Help 
                    <span id="helpTimer" class="help-timer" style="display: none;">00:04:20</span>
                    <i id="helpPhoneIcon" class="fas fa-phone-alt" style="display: none;"></i>
                </a>
                <div class="help-section" style="display: none;">
                    <div class="help-content">
                        <p>Talk to AI instead:</p>
                        <ul>
                            <li style="display: flex; align-items: center;">
                                <span class="online-indicator chatgpt-indicator"></span>
                                <a href="https://chat.openai.com" class="help-link" target="_blank">ChatGPT</a>
                            </li>
                            <li style="display: flex; align-items: center;">
                                <span class="online-indicator gemini-indicator"></span>
                                <a href="https://gemini.google.com" class="help-link" target="_blank">Google Gemini</a>
                            </li>
                        </ul>
                        <p class="help-note">Timer when live help is available. Cancel anytime.<br>Powered by mcp.dotmobile.app</p>
                    </div>
                </div>
            </div>
                <div class="settings-submenu" style="display: none;">
                    <a href="#" id="darkModeToggle"><i class="fas fa-moon"></i> <span>Dark Mode</span></a>
                </div>
                <a href="/" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </div>
        </div>
    </div>
    <div class="container">
        <div class="dashboard-content">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-credit-card"></i> Payment Methods</h2>
                <a href="/dashboard" class="btn-close" aria-label="Close"></a>
            </div>

            <!-- Wallet Section -->
            <div class="address-section mb-4">
                <h3 class="mb-3"><i class="fab fa-ethereum"></i> My Wallet</h3>
                <div class="wallet-card token-stats metamask-card">
                    <div class="wallet-content">
                        <div class="wallet-balance" style="display: flex; align-items: center; width: 100%;">
                            <span class="balance-amount">100</span>
                            <span class="wallet-symbol">DOTM</span>
                            <button class="btn btn-sm btn-outline-secondary token-refresh-btn" style="margin: 0 10px;" title="Refresh balance" onclick="refreshBalance()">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <span class="wallet-value">$100.00 USD</span>
                        </div>
                    </div>
                    <div class="wallet-actions">
                        <button class="btn btn-outline-primary btn-sm wallet-btn">
                            <i class="fas fa-exchange-alt"></i> Transfer to member
                        </button>
                        <button class="btn btn-outline-success btn-sm wallet-btn">
                            <i class="fas fa-sync"></i> Redeem for Data
                        </button>
                    </div>
                    <div class="metal-card-section">
                        <button class="btn btn-dark btn-sm metal-card-btn" onclick="preorderMetalCard()">
                            <i class="fas fa-credit-card"></i> PRE-ORDER METAL CARD
                        </button>
                        <div class="metamask-powered">Powered by MetaMask</div>
                    </div>
                </div>
            </div>

            <!-- Default Payment Method Section -->
            <div class="address-section mb-4">
                <h3 class="mb-3"><i class="fas fa-star"></i> Default</h3>
                <div class="address-card">
                    <div class="address-content">
                        <h4 class="payment-title">Visa ending in 4242</h4>
                        <p class="payment-detail">Expires 12/25</p>
                        <p class="text-success">Default payment method</p>
                    </div>
                    <i class="fas fa-edit edit-icon" onclick="editPaymentMethod(this)"></i>
                </div>
            </div>

            <!-- Other Payment Methods Section -->
            <div class="address-section mb-4">
                <h3 class="mb-3"><i class="fas fa-credit-card"></i> Other</h3>
                <div class="address-card mb-3">
                    <div class="address-content">
                        <h4 class="payment-title">Mastercard ending in 5555</h4>
                        <p class="payment-detail">Expires 08/25</p>
                        <p class="payment-status">&nbsp;</p>
                    </div>
                    <i class="fas fa-edit edit-icon" onclick="editPaymentMethod(this)"></i>
                </div>

                <div class="address-card">
                    <div class="address-content">
                        <h4 class="payment-title">Bitcoin Wallet</h4>
                        <p class="payment-detail">Connected via Stripe</p>
                        <p class="payment-status">&nbsp;</p>
                    </div>
                    <i class="fas fa-edit edit-icon" onclick="editPaymentMethod(this)"></i>
                </div>
            </div>

            <!-- Add Payment Method Section -->
            <div class="address-section mb-4">
                <h3 class="mb-3"><i class="fas fa-plus-circle"></i> Add</h3>
                <div class="address-card">
                    <div class="d-flex justify-content-between align-items-center w-100">
                        <button class="btn btn-primary">
                            <i class="fas fa-plus"></i> Add New Payment Method
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <style>
        .token-refresh-btn {
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            position: relative;
            z-index: 10;
        }
        .rotating {
            animation: rotate 1s linear infinite;
        }
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .token-stats {
            position: relative;
        }
        @keyframes ping {
            0% { transform: scale(0.5); opacity: 1; }
            100% { transform: scale(1.5); opacity: 0; }
        }
        .update-time {
            font-size: 0.8em;
            opacity: 0.8;
            margin-left: 4px;
        }
        .metamask-card {
            background-color: #FBE591; /* Gorse yellow color */
            border: 1px solid #E9D27E;
            transition: all 0.3s ease;
        }
        .metal-card-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(0,0,0,0.1);
            text-align: center;
        }
        .metal-card-btn {
            width: 80%;
            background: linear-gradient(45deg, #888, #bbb); /* Grey brushed aluminum look */
            color: white;
            border: none;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .metal-card-btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to right, 
                transparent 0%, 
                rgba(255,255,255,0.2) 50%, 
                transparent 100%);
            transform: skewX(-20deg);
            animation: shimmer 6s infinite; /* Doubled animation duration from 3s to 6s */
        }
        @keyframes shimmer {
            0% { transform: translateX(-100%) skewX(-20deg); }
            100% { transform: translateX(300%) skewX(-20deg); }
        }
        .metal-card-btn:hover {
            background: linear-gradient(45deg, #777, #999);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .metamask-powered {
            font-size: 0.8em;
            color: #666;
            margin-top: 8px;
        }
        .dark-mode .metamask-card {
            background-color: #9E7668;
            border-color: #7D5D51;
        }
        .dark-mode .metamask-powered {
            color: #aaa;
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/app.js"></script>
    <script>
        function refreshBalance() {
            const refreshButton = document.querySelector('.token-refresh-btn');
            refreshButton.classList.add('rotating');
            
            // Create status indicator if it doesn't exist
            let statusIndicator = document.querySelector('.sepolia-status');
            if (!statusIndicator) {
                statusIndicator = document.createElement('div');
                statusIndicator.className = 'sepolia-status';
                statusIndicator.style.fontSize = '0.7rem';
                statusIndicator.style.marginTop = '5px';
                statusIndicator.style.textAlign = 'center';
                document.querySelector('.token-stats').appendChild(statusIndicator);
            }
            
            statusIndicator.innerHTML = '<span style="color:#6b21a8">Connecting to Sepolia...</span>';

            // In a real implementation, you would call your API endpoint
            fetch('/api/token/balance/current_user')
                .then(response => response.json())
                .then(data => {
                    if (!data.error) {
                        document.querySelector('.balance-amount').textContent = data.balance.toFixed(2);
                        document.querySelector('.wallet-value').textContent = '$' + data.value_usd.toFixed(2) + ' USD';
                        statusIndicator.innerHTML = '<span style="color:green">✓ Updated from Sepolia <span class="update-time">just now</span></span>';

                        // Start a timer to update the timestamp
                        const updateTimeEl = statusIndicator.querySelector('.update-time');
                        if (updateTimeEl) {
                            let seconds = 0;
                            const updateTimer = setInterval(() => {
                                seconds++;
                                if (seconds < 60) {
                                    updateTimeEl.textContent = seconds < 10 ? 'just now' : `${seconds} sec ago`;
                                } else if (seconds < 3600) {
                                    const minutes = Math.floor(seconds / 60);
                                    updateTimeEl.textContent = `${minutes} min ago`;
                                } else {
                                    const hours = Math.floor(seconds / 3600);
                                    updateTimeEl.textContent = `${hours} hr ago`;
                                    // Stop updating after a day
                                    if (hours >= 24) {
                                        clearInterval(updateTimer);
                                    }
                                }
                            }, 1000);
                        }
                        
                        // Create a ping effect perfectly aligned with the refresh button
                        const refreshBtnRect = refreshButton.getBoundingClientRect();
                        const tokenStatsRect = document.querySelector('.token-stats').getBoundingClientRect();
                        
                        // Create a container for the ping effect that's positioned relative to the button
                        const pingContainer = document.createElement('div');
                        pingContainer.style.position = 'absolute';
                        pingContainer.style.left = '0';
                        pingContainer.style.top = '0';
                        pingContainer.style.width = '100%';
                        pingContainer.style.height = '100%';
                        pingContainer.style.pointerEvents = 'none';
                        refreshButton.style.position = 'relative'; // Ensure button has position relative
                        refreshButton.appendChild(pingContainer);
                        
                        const pingEffect = document.createElement('div');
                        pingEffect.style.position = 'absolute';
                        pingEffect.style.left = '0';
                        pingEffect.style.top = '0';
                        pingEffect.style.width = '100%';
                        pingEffect.style.height = '100%';
                        pingEffect.style.border = '2px solid #6b21a8';
                        pingEffect.style.borderRadius = '50%';
                        pingEffect.style.animation = 'ping 1s ease-out';
                        pingEffect.style.pointerEvents = 'none';
                        pingContainer.appendChild(pingEffect);
                        
                        // Remove ping effect after animation
                        setTimeout(() => {
                            document.querySelector('.token-stats').removeChild(pingEffect);
                        }, 1000);
                        
                        // Add ping animation style if not present
                        if (!document.querySelector('style#ping-animation')) {
                            const style = document.createElement('style');
                            style.id = 'ping-animation';
                            style.textContent = `
                                @keyframes ping {
                                    0% { transform: scale(0.5); opacity: 1; }
                                    100% { transform: scale(1.5); opacity: 0; }
                                }
                            `;
                            document.head.appendChild(style);
                        }
                    } else {
                        statusIndicator.innerHTML = '<span style="color:red">Error updating from Sepolia</span>';
                    }
                    refreshButton.classList.remove('rotating');
                })
                .catch(error => {
                    console.error('Error fetching balance:', error);
                    statusIndicator.innerHTML = '<span style="color:red">Failed to connect to Sepolia</span>';
                    refreshButton.classList.remove('rotating');
                });
        }
        
        function preorderMetalCard() {
            // Show confirmation dialog
            const confirmOrder = confirm("Preorder your DOTM Metal Card for $99.99?");
            if (!confirmOrder) return;
            
            // Create loading overlay
            const loadingOverlay = document.createElement('div');
            loadingOverlay.className = 'loading-overlay';
            loadingOverlay.innerHTML = `
                <div class="spinner"></div>
                <p>Processing your order...</p>
            `;
            document.body.appendChild(loadingOverlay);
            
            // Make API call to add product to cart
            fetch('/api/record-global-purchase', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    productId: 'metal_card' 
                })
            })
            .then(response => response.json())
            .then(data => {
                document.body.removeChild(loadingOverlay);
                
                if (data.status === 'success') {
                    alert("Your DOTM Metal Card has been preordered! You'll receive an email with details shortly.");
                } else {
                    alert("There was an error processing your order. Please try again.");
                }
            })
            .catch(error => {
                document.body.removeChild(loadingOverlay);
                console.error('Error ordering metal card:', error);
                alert("There was an error processing your order. Please try again.");
            });
        }
    </script>
</body>
</html>