<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>dot.</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.css" rel="stylesheet">
    <link href="/static/style.css" rel="stylesheet">

    <!-- Firebase SDK v8 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>

    <!-- Custom Firebase Scripts -->
    <script src="/static/firebase-init.js"></script>
    <script src="/static/firebase-auth.js"></script>

    <!-- Authentication Guard -->
    <script src="/static/auth-guard.js"></script>

    <style>
        .address-card {
            min-height: 150px; /* Increased height for larger cards */
            padding: 20px; /* Increased padding for better spacing */
            background: rgba(255, 255, 255, 0.05) !important;
        }
        .address-content {
            flex: 1; /* Allow address content to expand */
            margin-right: 20px; /* Add space between address and icon */
        }
        .address-card .fas.fa-edit {
            padding: 10px; /* Add padding to the edit icon */
            font-size: 1.2em;
        }

        .copy-btn {
            font-size: 0.8em;
            padding: 6px 10px;
            margin-left: 5px;
            min-width: 44px;
            min-height: 44px;
        }

        .text-break {
            word-break: break-all;
            word-wrap: break-word;
        }

        .info-grid p {
            margin-bottom: 1rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .info-grid p:last-child {
            border-bottom: none;
        }

        .font-monospace {
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9em;
        }

        .badge-secondary {
            background-color: #6c757d;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.8em;
        }

        .btn-group .btn {
            margin: 0 2px;
        }

        .esim-qr-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .esim-qr-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
            color: #333;
        }

        .service-status-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Phone number section styling */
        .phone-number-card {
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .phone-number-card .card-body {
            padding: 1rem;
        }

        .phone-number-card p {
            margin-bottom: 0.5rem;
            word-break: break-word;
        }

        .phone-number-value {
            font-size: 1.1rem;
            font-weight: 600;
            word-break: break-all;
        }

        .area-code-info {
            font-size: 0.9rem;
            line-height: 1.4;
            word-wrap: break-word;
        }

        /* Mobile-responsive styles */
        @media (max-width: 768px) {
            /* Container and padding adjustments */
            .container {
                padding-left: 15px !important;
                padding-right: 15px !important;
                padding-top: 70px !important;
            }

            /* Profile header */
            .dashboard-content h2 {
                font-size: 1.5rem !important;
                margin-bottom: 1rem !important;
            }

            /* User info section */
            .user-info {
                margin-bottom: 1.5rem !important;
            }

            .user-name {
                font-size: 1.2rem !important;
                display: block;
                margin-bottom: 0.5rem;
            }

            .user-email {
                font-size: 0.95rem !important;
            }

            .founding-shield {
                display: block !important;
                margin-top: 0.5rem !important;
                font-size: 0.75rem !important;
            }

            /* User IDs grid - stack vertically on mobile */
            .user-ids .row {
                margin-left: 0 !important;
                margin-right: 0 !important;
            }

            .user-ids .col-md-6 {
                padding-left: 0 !important;
                padding-right: 0 !important;
                margin-bottom: 1rem;
            }

            .user-ids p {
                font-size: 0.95rem !important;
                padding: 0.75rem 0 !important;
            }

            .user-ids strong {
                font-size: 1rem !important;
            }

            /* Monospace text - make more readable */
            .font-monospace {
                font-size: 0.85rem !important;
                word-break: break-all;
                line-height: 1.4;
            }

            /* Copy buttons - make larger and easier to tap */
            .copy-btn {
                font-size: 0.9rem !important;
                padding: 6px 10px !important;
                margin-left: 8px !important;
                min-width: 44px !important;
                min-height: 44px !important;
            }

            /* Section headings */
            .section-container h5,
            .section-container h4 {
                font-size: 1.1rem !important;
                margin-bottom: 1rem !important;
            }

            /* Cards and sections */
            .section-container {
                margin-bottom: 1.5rem !important;
                padding: 1rem !important;
            }

            .address-card {
                min-height: auto !important;
                padding: 1rem !important;
                margin-bottom: 1rem !important;
            }

            /* Buttons - make touch-friendly */
            .btn {
                min-height: 44px;
                font-size: 1rem !important;
                padding: 0.5rem 1rem !important;
            }

            .btn-sm {
                min-height: 38px;
                font-size: 0.9rem !important;
            }

            /* Badge adjustments */
            .badge-secondary {
                font-size: 0.85rem !important;
                padding: 0.35rem 0.65rem !important;
            }

            /* eSIM and service sections */
            .esim-card,
            .service-card {
                padding: 1rem !important;
                margin-bottom: 1rem !important;
            }

            /* Info grid items */
            .info-grid p {
                font-size: 0.95rem !important;
                padding: 0.75rem 0 !important;
            }

            /* Status badges - make more prominent */
            .service-status-badge {
                font-size: 0.85rem !important;
                padding: 0.6rem 1rem !important;
                display: block;
                text-align: center;
                margin-top: 0.5rem;
            }

            /* Refresh button */
            .btn-refresh {
                width: 100%;
                margin-top: 1rem;
            }

            /* Modal content on mobile */
            .esim-qr-content {
                padding: 20px !important;
                max-width: 95% !important;
            }

            .esim-qr-content h3 {
                font-size: 1.3rem !important;
            }

            .esim-qr-content p {
                font-size: 0.95rem !important;
            }

            /* Close button - make larger */
            .btn-close {
                min-width: 44px !important;
                min-height: 44px !important;
                padding: 1rem !important;
            }

            /* Address content */
            .address-content {
                margin-right: 10px !important;
            }

            /* Edit icons - larger touch targets */
            .fas.fa-edit {
                font-size: 1.4em !important;
                padding: 12px !important;
                min-width: 44px;
                min-height: 44px;
            }

            /* Button groups - stack on mobile */
            .btn-group {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
            }

            .btn-group .btn {
                width: 100%;
                margin: 0 !important;
            }

            /* Subscription cards */
            .subscription-card {
                padding: 1rem !important;
            }

            .subscription-card h6 {
                font-size: 1rem !important;
            }

            .subscription-card p {
                font-size: 0.9rem !important;
            }
        }

    </style>
</head>
<body class="dashboard-body">
    <div class="top-bar">
        <div class="menu-icon" onclick="toggleMenu(this)">
            <i class="fas fa-bars"></i>
            <div class="menu-dropdown">
                <a href="/dashboard"><i class="fas fa-database"></i> Data</a>
                <a href="/network"><i class="fas fa-network-wired"></i> Network</a>
                <a href="/marketplace"><i class="fas fa-store"></i> Marketplace</a>
                <a href="/notifications"><i class="fas fa-bell"></i> Notifications</a>
                <a href="/bitchat"><i class="fas fa-comments"></i> Bitchat</a>
            </div>
        </div>
        <div class="theme-toggles">
            <div id="darkModeToggle" class="theme-toggle active" title="Dark Mode">
                <i class="fas fa-moon"></i>
            </div>
            <div id="lightModeToggle" class="theme-toggle" title="Light Mode">
                <i class="fas fa-sun"></i>
            </div>
        </div>
        <div class="profile-section">
            <i class="fas fa-user-circle" onclick="toggleProfileDropdown()"></i>
            <div class="profile-dropdown">
                <div class="profile-info">
                    <div class="profile-header">
                        <span class="account-text">My Account</span>
                        <i class="fas fa-qrcode qr-code-icon" onclick="toggleQRCode(event)"></i>
                    </div>
                    <div class="wallet-pill-container">
                        <a href="/payments" class="wallet-value-pill" id="tokenBalancePill">
                            Loading DOTM...
                        </a>
                    </div>
                    <div id="qrCodePopup" class="qr-code-popup">
                        <div id="qrcode"></div>
                        <p id="qrMemberCount" class="member-count-qr">#1/X</p>
                        <p>Scan to link accounts</p>
                    </div>
                </div>
                <a href="/profile"><i class="fas fa-user"></i> Profile</a>
                <a href="#"><i class="fas fa-shopping-cart"></i> Orders</a>
                <a href="/payments"><i class="fas fa-credit-card"></i> Payments</a>
                <a href="#" id="settingsToggle"><i class="fas fa-cog"></i> Settings</a>
                <div class="settings-submenu" style="display: none;">
                    <a href="#" id="darkModeToggle"><i class="fas fa-moon"></i> <span data-translate="darkMode">Dark Mode</span></a>
                    <div class="language-selector-container">
                        <label for="languageSelect"><i class="fas fa-globe"></i> <span data-translate="language">Language</span></label>
                        <select id="languageSelect" class="language-select">
                            <option value="en" data-translate="english">English</option>
                            <option value="es" data-translate="spanish">Español</option>
                            <option value="fr" data-translate="french">Français</option>
                        </select>
                    </div>
                </div>
                <a href="#" id="logoutBtn" onclick="handleLogout(event)">
                    <i class="fas fa-sign-out-alt"></i> <span data-translate="logout">Logout</span>
                </a>
                <a href="#" id="helpToggle">
                    <i class="fas fa-question-circle"></i> <span id="helpText">Help</span>
                    <i id="helpPhoneIcon" class="fas fa-phone" style="display: none; margin-left: 8px;"></i>
                </a>
                <div class="help-section" style="display: none;">
                    <div class="help-content">
                        <p><i class="fas fa-question-circle"></i> Talk to AI instead:</p>
                        <ul>
                            <li style="display: flex; align-items: center;">
                                <span class="online-indicator chatgpt-indicator"></span>
                                <a href="https://chat.openai.com" class="help-link" target="_blank">ChatGPT</a>
                            </li>
                            <li style="display: flex; align-items: center;">
                                <span class="online-indicator gemini-indicator"></span>
                                <a href="https://gemini.google.com" class="help-link" target="_blank">Google Gemini</a>
                            </li>
                        </ul>
                        <p class="help-note">LLMs goto mcp.dotmobile.app</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="container" style="padding-top: 60px;">
        <div class="dashboard-content">
            <!-- Member Badge - moved above Profile heading -->
            <div class="mb-2 text-center">
                <span class="founding-shield" id="memberBadge" style="display: inline-block; padding: 0.5rem 1rem; background: linear-gradient(135deg, #FFD700, #FFA500); color: #333; border-radius: 20px; font-weight: bold;">⭐ Member</span>
            </div>

            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-user-circle"></i> Profile</h2>
                <a href="/dashboard" class="btn-close" aria-label="Close"></a>
            </div>
            <div class="profile-details">
                <div class="user-info mb-4">
                    <div class="email-container">
                        <div class="user-info-header">
                            <div class="user-name" id="profileUserName" style="display: block; margin-bottom: 0.5rem;">John Doe</div>
                            <div class="user-email" id="profileUserEmail" style="display: block;">john@example.com</div>
                        </div>
                    </div>

                    <!-- eSIM Details Section -->
                    <div class="esim-section mb-4">
                        <div class="card" style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); backdrop-filter: blur(5px);">
                            <div class="card-header d-flex justify-content-between align-items-center" style="background: transparent; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                                <h4 style="color: var(--text-primary); margin: 0;"><i class="fas fa-sim-card"></i> My eSIMs</h4>
                                <button class="btn btn-sm btn-outline-primary" onclick="loadESIMDetails()">
                                    <i class="fas fa-refresh"></i> Show
                                </button>
                            </div>
                            <div class="card-body" style="background: transparent;">
                                <div id="esimLoading" class="text-center" style="display: none; color: var(--text-primary);">
                                    <i class="fas fa-spinner fa-spin"></i> Loading eSIM details...
                                </div>
                                <div id="esimNoData" class="text-center mb-4" style="display: none; color: var(--text-secondary); padding: 2rem;">
                                    <i class="fas fa-sim-card" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i><br>
                                    <p style="margin: 1rem 0;">No eSIM assigned yet.</p>
                                    <a href="/buy/esim" class="btn btn-primary" style="margin-top: 0.5rem;">Purchase your first eSIM for $1</a>
                                </div>
                                <!-- New section for Beta eSIM -->
                                <div id="betaEsimCard" style="display: none;"></div>
                                <div id="esimDetails" style="display: none;">
                                    <!-- eSIM details will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <div class="card address-card">
                                <div class="card-body" style="text-align: center;">
                                    <div class="address-content" style="text-align: center; margin: 0 auto; max-width: 600px;">
                                        <h5 style="text-align: center; margin-bottom: 1.5rem;">Account Details</h5>
                                        <div class="info-grid" style="text-align: center;">
                                            <p style="text-align: center; display: flex; flex-direction: column; align-items: center; margin-bottom: 1.5rem;">
                                                <strong style="text-align: center; margin-bottom: 0.5rem;">UID:</strong>
                                                <span class="text-break font-monospace" id="firebaseUID" style="text-align: center; margin-bottom: 0.5rem;">Loading...</span>
                                                <button class="btn btn-sm btn-outline-secondary copy-btn" onclick="copyFirebaseUID()" title="Copy UID"><i class="fas fa-copy"></i></button>
                                            </p>
                                            <p style="text-align: center; display: none; flex-direction: column; align-items: center; margin-bottom: 1.5rem;">
                                                <strong style="text-align: center; margin-bottom: 0.5rem;">Member#:</strong>
                                                <span class="text-break" id="dotUserID" style="text-align: center; margin-bottom: 0.5rem;">Loading...</span>
                                                <button class="btn btn-sm btn-outline-secondary copy-btn" id="dotUserIDCopyBtn" onclick="copyDotUserID()" title="Copy Member#" style="display: none;"><i class="fas fa-copy"></i></button>
                                            </p>
                                            <p style="text-align: center; display: flex; flex-direction: column; align-items: center; margin-bottom: 1.5rem;">
                                                <strong style="text-align: center; margin-bottom: 0.5rem;">NetworkID:</strong>
                                                <span class="text-break font-monospace" id="oxioUserID" style="text-align: center; margin-bottom: 0.5rem;">Loading...</span>
                                                <button class="btn btn-sm btn-outline-secondary copy-btn" id="oxioUserIDCopyBtn" onclick="copyOxioUserID()" title="Copy NetworkID" style="display: none;"><i class="fas fa-copy"></i></button>
                                            </p>
                                            <p style="text-align: center; display: flex; flex-direction: column; align-items: center; margin-bottom: 0;">
                                                <strong style="text-align: center; margin-bottom: 0.5rem;">GroupID:</strong>
                                                <span class="text-break font-monospace" id="oxioGroupID" style="text-align: center; margin-bottom: 0.5rem;">Loading...</span>
                                                <button class="btn btn-sm btn-outline-secondary copy-btn" id="oxioGroupIDCopyBtn" onclick="copyOxioGroupID()" title="Copy GroupID" style="display: none;"><i class="fas fa-copy"></i></button>
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- eSIM ICCID & QR Code Section -->
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="card border-info mb-3" id="iccidSection" style="display: none;">
                                        <div class="card-header d-flex justify-content-between align-items-center bg-info text-white">
                                            <h5 class="mb-0"><i class="fas fa-qrcode"></i> My eSIM Details</h5>
                                            <button class="btn btn-sm btn-outline-light" onclick="loadAssignedICCID()">
                                                <i class="fas fa-refresh"></i> Refresh
                                            </button>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-8">
                                                    <p><strong>Phone Number:</strong><br>
                                                        <span class="text-break font-weight-bold" style="font-size: 1.1rem;">+1 (929) 654-7725</span>
                                                    </p>
                                                    <p><strong>ICCID:</strong><br>
                                                        <span class="text-break font-monospace bg-light p-2 rounded d-inline-block" id="assignedICCID">-</span>
                                                        <button class="btn btn-sm btn-outline-secondary copy-btn ms-1" onclick="copyAssignedICCID()" title="Copy ICCID"><i class="fas fa-copy"></i></button>
                                                    </p>
                                                    <p><strong>Status:</strong>
                                                        <span class="badge" id="iccidStatus">-</span>
                                                    </p>
                                                    <p><strong>Country:</strong>
                                                        <span id="iccidCountry">-</span>
                                                    </p>
                                                    <p><strong>LPA Activation Code:</strong><br>
                                                        <span class="text-break font-monospace bg-warning p-2 rounded d-inline-block small" id="lpaCode">-</span>
                                                        <button class="btn btn-sm btn-outline-secondary copy-btn ms-1" onclick="copyLPACode()" title="Copy LPA Code"><i class="fas fa-copy"></i></button>
                                                    </p>
                                                </div>
                                                <div class="col-md-4 text-center">
                                                    <p><strong>Activation QR Code</strong></p>
                                                    <div class="qr-code-container" id="qrCodeContainer">
                                                        <div id="qrCodeSVG" style="max-width: 200px; margin: 0 auto;">
                                                            <!-- SVG QR code will be loaded here -->
                                                        </div>
                                                        <div class="mt-2">
                                                            <button class="btn btn-sm btn-success" onclick="downloadQRCode()" id="downloadQRBtn" style="display: none;">
                                                                <i class="fas fa-download"></i> Download QR
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="noICCIDMessage" class="alert alert-info" style="background: rgba(23, 162, 184, 0.1); border: 1px solid rgba(23, 162, 184, 0.3); color: var(--text-primary);">
                                        <i class="fas fa-info-circle"></i> No eSIM assigned yet. <a href="/buy/esim">Purchase your first eSIM for $1</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="address-section mb-4">
                    <h3 class="mb-3"><i class="fas fa-mobile-alt"></i> Wireless Services</h3>

                    <!-- Network Services Overview -->
                    <div class="card mb-3" style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1);">
                        <div class="card-header d-flex justify-content-between align-items-center" style="background: transparent; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                            <h5 style="color: var(--text-primary); margin: 0;"><i class="fas fa-network-wired"></i> Network Services</h5>
                            <a href="/network" class="btn btn-sm btn-primary">
                                <i class="fas fa-cog"></i> Manage Services
                            </a>
                        </div>
                        <div class="card-body" style="background: transparent;">
                            <div id="networkServicesLoading" class="text-center" style="color: var(--text-primary);">
                                <i class="fas fa-spinner fa-spin"></i> Loading network services...
                            </div>
                            <div id="networkServicesContent" style="display: none;">
                                <div id="activeServicesList">
                                    <!-- Active services will be loaded here -->
                                </div>
                                <div id="noActiveServices" style="display: none; text-align: center; color: var(--text-secondary); padding: 2rem;">
                                    <i class="fas fa-info-circle" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                                    <p>No network services are currently active.</p>
                                    <a href="/network" class="btn btn-outline-primary btn-sm">Browse Available Services</a>
                                </div>
                            </div>
                            <div id="networkServicesError" style="display: none; text-align: center; color: var(--text-secondary); padding: 2rem;">
                                <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                                <p>Unable to load network services.</p>
                                <button onclick="loadNetworkServicesOverview()" class="btn btn-outline-secondary btn-sm">Retry</button>
                            </div>
                        </div>
                    </div>

                    <!-- OXIO Service Information -->
                    <div id="oxioContainer">
                        <div class="address-card p-3 mb-3" style="text-align: center; color: var(--text-secondary);">
                            <p>Loading OXIO information...</p>
                        </div>
                    </div>
                </div>

                <div class="address-section mb-4">
                    <h3 class="mb-3"><i class="fas fa-sync"></i> Subscriptions</h3>
                    <div id="subscriptionContainer">
                        <div class="address-card p-3 mb-3" style="background: rgba(255, 255, 255, 0.1); border-radius: 8px;">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="address-content" id="billingAddressContent">
                                    <!-- Subscription information will be displayed here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="address-section mb-4">
                    <h3 class="mb-3"><i class="fas fa-mobile-alt"></i> Phone Numbers</h3>
                    <div id="betaPhoneContainer">
                        <div class="address-card p-3 mb-3" style="text-align: center; color: #666;">
                            <p>Loading phone number information...</p>
                        </div>
                    </div>
                </div>

                <div class="address-section mb-4">
                    <h3 class="mb-3"><i class="fas fa-file-invoice"></i> Billing Address</h3>
                    <div id="billingAddressDisplay" style="display: none;">
                        <div class="address-card p-3 mb-3" style="background: rgba(255, 255, 255, 0.1); border-radius: 8px;">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="address-content" id="billingAddressContent">
                                    <!-- Billing address will be displayed here -->
                                </div>
                                <i class="fas fa-edit edit-icon" onclick="editBillingAddress()" style="cursor: pointer;"></i>
                            </div>
                        </div>
                    </div>
                    <div id="billingAddressEmpty" style="display: none;">
                        <button class="btn btn-outline-primary" onclick="showBillingAddressForm()">
                            <i class="fas fa-plus"></i> Add Billing Address
                        </button>
                    </div>
                    <div id="billingAddressForm" style="display: none; margin-top: 15px;">
                        <div class="address-card p-3" style="background: rgba(255, 255, 255, 0.1); border-radius: 8px;">
                            <div class="row">
                                <div class="col-md-8 mb-3">
                                    <label>Street Address</label>
                                    <input type="text" class="form-control" id="billingStreet" placeholder="123 Main Street" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label>Unit/Apt</label>
                                    <input type="text" class="form-control" id="billingUnit" placeholder="Unit 45">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label>City</label>
                                    <input type="text" class="form-control" id="billingCity" placeholder="Toronto" required>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label>Province/State</label>
                                    <input type="text" class="form-control" id="billingProvince" placeholder="ON" required>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label>Postal Code</label>
                                    <input type="text" class="form-control" id="billingPostal" placeholder="M5V 2T6" required>
                                </div>
                                <div class="col-md-12 mb-3">
                                    <label>Country</label>
                                    <select class="form-control" id="billingCountry" required>
                                        <option value="Canada">Canada</option>
                                        <option value="United States">United States</option>
                                        <option value="Mexico">Mexico</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div class="col-md-12">
                                    <button class="btn btn-primary" onclick="saveBillingAddress()">
                                        <i class="fas fa-save"></i> Save Billing Address
                                    </button>
                                    <button class="btn btn-secondary ml-2" onclick="cancelBillingAddressForm()">
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="address-section mb-4">
                    <h3 class="mb-3"><i class="fas fa-shipping-fast"></i> Mailing Address</h3>
                    <div id="mailingAddressDisplay" style="display: none;">
                        <div class="address-card p-3 mb-3" style="background: rgba(255, 255, 255, 0.1); border-radius: 8px;">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="address-content" id="mailingAddressContent">
                                    <!-- Mailing address will be displayed here -->
                                </div>
                                <i class="fas fa-edit edit-icon" onclick="editMailingAddress()" style="cursor: pointer;"></i>
                            </div>
                        </div>
                    </div>
                    <div id="mailingAddressEmpty" style="display: none;">
                        <button class="btn btn-outline-primary" onclick="showMailingAddressForm()">
                            <i class="fas fa-plus"></i> Add Mailing Address
                        </button>
                    </div>
                    <div id="mailingAddressForm" style="display: none; margin-top: 15px;">
                        <div class="address-card p-3" style="background: rgba(255, 255, 255, 0.1); border-radius: 8px;">
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="sameAsBilling" onchange="toggleSameAsBilling()">
                                        <label class="form-check-label" for="sameAsBilling">
                                            Same as Billing Address
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-8 mb-3">
                                    <label>Street Address</label>
                                    <input type="text" class="form-control" id="mailingStreet" placeholder="123 Main Street" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label>Unit/Apt</label>
                                    <input type="text" class="form-control" id="mailingUnit" placeholder="Unit 45">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label>City</label>
                                    <input type="text" class="form-control" id="mailingCity" placeholder="Toronto" required>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label>Province/State</label>
                                    <input type="text" class="form-control" id="mailingProvince" placeholder="ON" required>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label>Postal Code</label>
                                    <input type="text" class="form-control" id="mailingPostal" placeholder="M5V 2T6" required>
                                </div>
                                <div class="col-md-12 mb-3">
                                    <label>Country</label>
                                    <select class="form-control" id="mailingCountry" required>
                                        <option value="Canada">Canada</option>
                                        <option value="United States">United States</option>
                                        <option value="Mexico">Mexico</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div class="col-md-12">
                                    <button class="btn btn-primary" onclick="saveMailingAddress()">
                                        <i class="fas fa-save"></i> Save Mailing Address
                                    </button>
                                    <button class="btn btn-secondary ml-2" onclick="cancelMailingAddressForm()">
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="address-section mb-4">
                    <h3 class="mb-3"><i class="fas fa-wifi"></i> Broadband</h3>
                    <div id="broadbandAddressDisplay" style="display: none;">
                        <div class="address-card p-3 mb-3" style="background: rgba(255, 255, 255, 0.1); border-radius: 8px;">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="address-content" id="broadbandAddressContent">
                                    <!-- Broadband address will be displayed here -->
                                </div>
                                <i class="fas fa-edit edit-icon" onclick="editBroadbandAddress()" style="cursor: pointer;"></i>
                            </div>
                        </div>
                    </div>
                    <div id="broadbandAddressEmpty" style="display: none;">
                        <button class="btn btn-outline-primary" onclick="showBroadbandAddressForm()">
                            <i class="fas fa-plus"></i> Add Broadband Address
                        </button>
                    </div>
                    <div id="broadbandAddressForm" style="display: none; margin-top: 15px;">
                        <div class="address-card p-3" style="background: rgba(255, 255, 255, 0.1); border-radius: 8px;">
                            <div class="row">
                                <div class="col-md-8 mb-3">
                                    <label>Street Address</label>
                                    <input type="text" class="form-control" id="broadbandStreet" placeholder="123 Broadband Way" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label>Unit/Apt</label>
                                    <input type="text" class="form-control" id="broadbandUnit" placeholder="Unit 101">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label>City</label>
                                    <input type="text" class="form-control" id="broadbandCity" placeholder="Metropolis" required>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label>Province/State</label>
                                    <input type="text" class="form-control" id="broadbandProvince" placeholder="ON" required>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label>Postal Code</label>
                                    <input type="text" class="form-control" id="broadbandPostal" placeholder="M5V 2T6" required>
                                </div>
                                <div class="col-md-12 mb-3">
                                    <label>Country</label>
                                    <select class="form-control" id="broadbandCountry" required>
                                        <option value="Canada">Canada</option>
                                        <option value="United States">United States</option>
                                        <option value="Mexico">Mexico</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div class="col-md-12">
                                    <button class="btn btn-primary" onclick="saveBroadbandAddress()">
                                        <i class="fas fa-save"></i> Save Broadband Address
                                    </button>
                                    <button class="btn btn-secondary ml-2" onclick="cancelBroadbandAddressForm()">
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Phone Number Popup -->
    <div id="phoneNumberPopup" class="esim-qr-modal" style="display: none;">
        <div class="esim-qr-content">
            <h4>Phone Number Information</h4>
            <div id="popupContent">
                <!-- Phone number details will be loaded here -->
            </div>
            <button onclick="hidePhoneNumberPopup()" class="btn btn-secondary mt-3">Close</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="/static/translations.js"></script>
    <script src="/static/help-desk.js"></script>
    <script src="/static/app.js"></script>
    <script src="/static/global-audio-player.js"></script>
    <script>
        // Helper function to get Firebase UID
        function getFirebaseUID() {
            // Check if Firebase is initialized and user is logged in
            if (typeof firebase !== 'undefined' && firebase.auth && firebase.auth().currentUser) {
                return firebase.auth().currentUser.uid;
            }
            // Fallback to checking localStorage for cached user data
            const cachedUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
            return cachedUser?.uid || null;
        }

        // Listen for Firebase auth state changes - PRIMARY auth handler for profile
        document.addEventListener('firebaseAuthStateChanged', function(event) {
            const { isSignedIn, firebaseUser, userData } = event.detail;

            console.log('Profile page received auth state change:', event.detail);

            if (isSignedIn && firebaseUser) {
                console.log('Profile: User authenticated, loading profile data for:', firebaseUser.uid);
                // Load all user-specific data only after authentication is confirmed
                loadFirebaseUserData();
                loadNetworkServicesOverview(); // Load network services overview
            } else {
                console.log('Profile: No authenticated user, redirecting to login');
                window.location.href = '/login';
            }
        });

        // Direct API call to load user data as fallback
        async function loadUserDataDirectly() {
            try {
                // Get Firebase UID from localStorage or auth state
                const cachedUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
                const firebaseUid = cachedUser?.uid;

                if (!firebaseUid) {
                    console.log('No Firebase UID available, skipping direct API call');
                    return;
                }

                console.log('Direct API call for user data:', firebaseUid);

                const response = await fetch(`/api/auth/current-user?firebaseUid=${firebaseUid}`, {
                    headers: {
                        'Authorization': `Bearer ${firebaseUid}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                console.log('Direct API response:', data);

                if (response.ok && data.status === 'success') {
                    // Direct DOM updates to ensure OXIO data displays
                    const oxioUserIDElement = document.getElementById('oxioUserID');
                    if (oxioUserIDElement && data.oxioUserId) {
                        oxioUserIDElement.textContent = data.oxioUserId;
                        console.log('Updated OXIO User ID:', data.oxioUserId);
                    }

                    const oxioGroupIDElement = document.getElementById('oxioGroupID');
                    if (oxioGroupIDElement && data.oxioGroupId) {
                        oxioGroupIDElement.textContent = data.oxioGroupId;
                        console.log('Updated OXIO Group ID:', data.oxioGroupId);
                    }

                    const dotUserIDElement = document.getElementById('dotUserID');
                    if (dotUserIDElement && data.userId) {
                        dotUserIDElement.textContent = data.userId;
                        console.log('Updated DOT User ID:', data.userId);
                    }

                    const firebaseUIDElement = document.getElementById('firebaseUID');
                    if (firebaseUIDElement) {
                        firebaseUIDElement.textContent = firebaseUid;
                    }

                    // Also load eSIM data to populate SIM card number
                    loadESIMDataDirectly(firebaseUid);
                }
            } catch (error) {
                console.error('Direct API call error:', error);
            }
        }

        // Direct API call to load eSIM data including ICCID
        async function loadESIMDataDirectly(firebaseUid) {
            try {
                console.log('Loading eSIM data directly for:', firebaseUid);

                const response = await fetch(`/api/user-esim-details?firebaseUid=${firebaseUid}`, {
                    headers: {
                        'X-Admin-Token': 'replit_admin_token_2024',
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                console.log('eSIM API response:', data);

                if (response.ok && data.success && data.esims && data.esims.length > 0) {
                    const firstESIM = data.esims[0];

                    // Update SIM card number (ICCID)
                    const simCardElement = document.getElementById('simCardNumber');
                    if (simCardElement && firstESIM.iccid) {
                        simCardElement.textContent = firstESIM.iccid;
                        console.log('Updated SIM Card Number:', firstESIM.iccid);
                    }
                } else {
                    // If no eSIM data available, set ICCID from database
                    const simCardElement = document.getElementById('simCardNumber');
                    if (simCardElement) {
                        simCardElement.textContent = '8910650420001501340F'; // Known ICCID from activation
                    }
                }
            } catch (error) {
                console.error('eSIM data loading error:', error);
                // Set fallback ICCID
                const simCardElement = document.getElementById('simCardNumber');
                if (simCardElement) {
                    simCardElement.textContent = '8910650420001501340F'; // Known ICCID from activation
                }
            }
        }

        function loadFirebaseUserData() {
            try {
                console.log('Loading Firebase user data...');

                // First, try to load data from localStorage (faster, works offline)
                const cachedUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
                if (cachedUser && cachedUser.uid) {
                    console.log('Found cached user data:', cachedUser);
                    displayUserData(cachedUser);
                }

                // Then check Firebase for real-time updates
                if (typeof firebase === 'undefined' || !firebase.auth) {
                    console.log('Firebase not available yet, waiting...');
                    setTimeout(loadFirebaseUserData, 500);
                    return;
                }

                // Check current auth state immediately
                const currentUser = firebase.auth().currentUser;
                if (currentUser) {
                    console.log('Found current Firebase user:', currentUser.email);
                    console.log('Firebase UID:', currentUser.uid);

                    // If we don't have cached data, show Firebase data immediately
                    if (!cachedUser || !cachedUser.uid) {
                        const basicUserData = {
                            uid: currentUser.uid,
                            email: currentUser.email,
                            displayName: currentUser.displayName
                        };
                        displayUserData(basicUserData);
                    }

                    // Load additional user data from our API (in background)
                    loadUserDataFromAPI(currentUser.uid);

                    // Load user addresses
                    loadUserAddresses();

                    // Load OXIO data with Firebase UID
                    loadOxioDataWithUID(currentUser.uid);

                    // Load assigned ICCID data with QR codes
                    loadAssignedICCID();

                    // Load subscription data with Firebase UID
                    loadSubscriptionDataWithUID(currentUser.uid);

                    // Load beta phone numbers with Firebase UID
                    loadBetaPhoneNumbers(currentUser.uid);
                } else {
                    // No authenticated user found, redirect to login
                    console.log('No authenticated user found, redirecting to login');
                    window.location.href = '/login';
                }

            } catch (error) {
                console.error('Error loading Firebase user data:', error);
                // Try to redirect to login on error
                setTimeout(() => {
                    window.location.href = '/login';
                }, 1000);
            }
        }

        function displayUserData(userData) {
            console.log('Displaying user data:', userData);
            console.log('DOT User ID value:', userData.userId);

            // Update email
            if (userData.email) {
                const emailElement = document.getElementById('profileUserEmail');
                if (emailElement) {
                    emailElement.textContent = userData.email;
                }
            }

            // Update display name (badge is separate now)
            const nameElement = document.getElementById('profileUserName');
            if (nameElement && userData.email) {
                const displayName = userData.displayName || userData.email.split('@')[0];
                nameElement.textContent = displayName;
            }

            // Update member badge based on founder status
            const badgeElement = document.getElementById('memberBadge');
            if (badgeElement && userData.email) {
                const founderBadge = userData.founderStatus === 'Y' ? '⭐ Founding Member' : '⭐ Member';
                badgeElement.textContent = founderBadge;
            }

            // Update Firebase UID
            if (userData.uid) {
                const firebaseUIDElement = document.getElementById('firebaseUID');
                if (firebaseUIDElement) {
                    firebaseUIDElement.textContent = userData.uid;
                }
            }

            // Update DOT User ID - ALWAYS show if available
            const dotUserIDElement = document.getElementById('dotUserID');
            const dotUserIDCopyBtn = document.getElementById('dotUserIDCopyBtn');
            if (dotUserIDElement) {
                const dotUserId = userData.userId;
                console.log('Setting DOT User ID element to:', dotUserId);

                if (dotUserId && dotUserId !== 'N/A' && dotUserId !== null && dotUserId !== undefined) {
                    dotUserIDElement.textContent = dotUserId;
                    if (dotUserIDCopyBtn) {
                        dotUserIDCopyBtn.style.display = 'inline-block';
                    }
                } else {
                    dotUserIDElement.textContent = 'N/A';
                    if (dotUserIDCopyBtn) {
                        dotUserIDCopyBtn.style.display = 'none';
                    }
                }
            }

            // Update OXIO User ID
            const oxioUserIDElement = document.getElementById('oxioUserID');
            const oxioUserIDCopyBtn = document.getElementById('oxioUserIDCopyBtn');
            if (oxioUserIDElement) {
                const oxioUserId = userData.oxioUserId || 'N/A';
                console.log('🔍 OXIO User ID from API:', oxioUserId);
                console.log('📦 Full userData object:', userData);
                oxioUserIDElement.textContent = oxioUserId;
                if (oxioUserIDCopyBtn) {
                    oxioUserIDCopyBtn.style.display = (oxioUserId && oxioUserId !== 'N/A') ? 'inline-block' : 'none';
                }
            }

            // Update OXIO Group ID
            const oxioGroupIDElement = document.getElementById('oxioGroupID');
            const oxioGroupIDCopyBtn = document.getElementById('oxioGroupIDCopyBtn');
            if (oxioGroupIDElement) {
                const oxioGroupId = userData.oxioGroupId || 'N/A';
                oxioGroupIDElement.textContent = oxioGroupId;
                if (oxioGroupIDCopyBtn) {
                    oxioGroupIDCopyBtn.style.display = (oxioGroupId && oxioGroupId !== 'N/A') ? 'inline-block' : 'none';
                }
            }
        }

        async function loadUserDataFromAPI(firebaseUid) {
            if (!firebaseUid) {
                console.error('SECURITY: No Firebase UID provided to loadUserDataFromAPI');
                return;
            }

            try {
                // SECURITY: Verify this matches the current authenticated user
                if (typeof firebase !== 'undefined' && firebase.auth && firebase.auth().currentUser) {
                    const currentUser = firebase.auth().currentUser;
                    if (currentUser.uid !== firebaseUid) {
                        console.error(`SECURITY WARNING: Profile trying to load data for ${firebaseUid} but current user is ${currentUser.uid}`);
                        return;
                    }

                    // Get Firebase ID token for authenticated API call
                    const idToken = await currentUser.getIdToken();

                    console.log('SECURITY: Loading profile data with authentication for:', firebaseUid);

                    const response = await fetch(`/api/auth/current-user?firebaseUid=${firebaseUid}`, {
                        headers: {
                            'Authorization': `Bearer ${idToken}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    const data = await response.json();

                    if (response.ok && data.status === 'success') {
                        console.log('Loaded authenticated user data from API:', data);
                        console.log('DOT User ID from API:', data.userId);

                        // SECURITY: Double-check the email matches what we expect
                        if (data.email !== currentUser.email) {
                            console.error(`SECURITY WARNING: API returned data for ${data.email} but current user is ${currentUser.email}`);
                            return;
                        }

                        // Create complete user data object
                        const completeUserData = {
                            uid: firebaseUid,
                            email: data.email,
                            displayName: data.displayName,
                            userId: data.userId,
                            founderStatus: data.founderStatus,
                            stripeCustomerId: data.stripeCustomerId,
                            oxioUserId: data.oxioUserId,
                            metamaskAddress: data.metamaskAddress,
                            oxioGroupId: data.oxioGroupId,
                            _verified: true, // Mark as verified
                            _timestamp: Date.now()
                        };

                        // Update display with fresh API data
                        displayUserData(completeUserData);

                        // Store updated user data in localStorage
                        localStorage.setItem('currentUser', JSON.stringify(completeUserData));
                    } else {
                        console.error('API error:', data);
                        showProfileError('Failed to load user data');
                    }
                } else {
                    console.error('SECURITY: Firebase not available or user not authenticated');
                    showProfileError('Authentication required');
                }
            } catch (error) {
                console.error('Error loading user data from API:', error);
                showProfileError('Error loading user data');
            }
        }

        function showProfileError(message) {
            // Update fields to show N/A for missing data
            const dotUserIDElement = document.getElementById('dotUserID');
            if (dotUserIDElement) {
                dotUserIDElement.textContent = 'N/A';
            }

            const oxioUserIDElement = document.getElementById('oxioUserID');
            if (oxioUserIDElement) {
                oxioUserIDElement.textContent = 'N/A';
            }

            const oxioGroupIDElement = document.getElementById('oxioGroupID');
            if (oxioGroupIDElement) {
                oxioGroupIDElement.textContent = 'N/A';
            }
        }

        function loadOxioData() {
            // This function is kept for backward compatibility but will use the new one
            loadOxioDataWithUID(null);
        }

        function loadOxioDataWithUID(firebaseUid) {
            // This function is now deprecated - data is loaded by loadUserDataFromAPI() and loadESIMDetails()
            // Just display a simple status message
            const container = document.getElementById('oxioContainer');
            if (container) {
                container.innerHTML = `
                    <div class="address-card p-3 mb-3">
                        <p class="text-muted mb-0"><i class="fas fa-check-circle text-success"></i> Service information loaded from database</p>
                    </div>
                `;
            }
        }

        function displayOxioData(data) {
            const container = document.getElementById('oxioContainer');
            const refreshBtn = document.getElementById('oxioRefreshBtn');

            if (data.status === 'success' && data.oxio_data) {
                const oxioData = data.oxio_data;

                // Check if OXIO user needs to be created
                if (oxioData.status === 'oxio_user_not_created' || !oxioData.oxio_user_id) {
                    displayOxioError(oxioData.error || 'OXIO user not created yet');
                    return;
                }

                // Show refresh button
                if (refreshBtn) refreshBtn.style.display = 'block';

                // Check if user has real line data (not demo)
                const hasRealLineData = oxioData.line_id && oxioData.line_id !== 'Not assigned' &&
                                       oxioData.phone_number && oxioData.phone_number !== 'Not assigned';

                // Determine if this is demo data or real data
                const isDemoUser = oxioData.email && oxioData.email.includes('demo') ||
                                  oxioData.status === 'demo' ||
                                  !hasRealLineData;

                // Format regions
                const regionsText = oxioData.regions && oxioData.regions.length > 0
                    ? oxioData.regions.join(', ')
                    : 'Not specified';

                // Status badge color
                const statusColor = getOxioStatusColor(oxioData.status);

                // Helper function to create copy button (only for real data)
                const createCopyButton = (value, label) => {
                    if (!value || value === 'Not created' || value === 'Not assigned' || value === 'N/A' || isDemoUser) {
                        return '';
                    }
                    return ` <button class="btn btn-sm btn-outline-secondary copy-btn" onclick="copyToClipboard('${value}', '${label}')" title="Copy ${label}"><i class="fas fa-copy"></i></button>`;
                };

                if (isDemoUser) {
                    // Update SIM card number in user info section
                    const simCardElement = document.getElementById('simCardNumber');
                    if (simCardElement) {
                        simCardElement.textContent = oxioData.iccid || 'Not assigned';
                    }

                    // Display demo/setup message for demo users
                    container.innerHTML = `
                        <div class="address-card p-3 mb-3">
                            <div class="address-content">
                                <div class="row">
                                    <div class="col-12 text-center">
                                        <h5><i class="fas fa-info-circle me-2 text-primary"></i>Wireless Service Setup</h5>
                                        <p class="text-muted">Your wireless service is being set up. Complete your subscription to activate your line.</p>
                                        <div class="mt-3">
                                            <a href="/marketplace" class="btn btn-primary me-2">
                                                <i class="fas fa-shopping-cart"></i> Purchase Plan
                                            </a>
                                            <button class="btn btn-outline-secondary" onclick="refreshOxioData()">
                                                <i class="fas fa-sync"></i> Check Status
                                            </button>
                                        </div>
                                        <div class="row mt-4">
                                            <div class="col-md-6">
                                                <h6>Account Information</h6>
                                                <p><strong>OXIO User ID:</strong> <span class="text-break">${oxioData.oxio_user_id || 'Creating...'}</span></p>
                                                <p><strong>OXIO Group ID:</strong> <span class="text-break">${oxioData.oxio_group_id || 'Creating...'}</span></p>
                                                <p><strong>Email:</strong> ${oxioData.email || 'N/A'}</p>
                                                <p><strong>Status:</strong> <span style="color: ${statusColor};">${formatOxioStatus(oxioData.status)}</span></p>
                                            </div>
                                            <div class="col-md-6">
                                                <h6>Service Status</h6>
                                                <p><strong>Line Status:</strong> Pending Activation</p>
                                                <p><strong>Phone Number:</strong> Will be assigned after purchase</p>
                                                <p><strong>Plan:</strong> Select from marketplace</p>
                                                <p><strong>SIM Card (ICCID):</strong> ${oxioData.iccid || 'Not assigned'}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // Update SIM card number in user info section
                    const simCardElement = document.getElementById('simCardNumber');
                    if (simCardElement) {
                        simCardElement.textContent = oxioData.iccid || 'Not assigned';
                    }

                    // Display comprehensive wireless service information for active users
                    const esimDetailsJson = JSON.stringify({
                        iccid: oxioData.iccid,
                        activation_code: oxioData.activation_code,
                        qr_code: oxioData.qr_code,
                        profile_id: oxioData.profile_id,
                        plan_name: oxioData.plan_name,
                        phone_number: oxioData.phone_number,
                        line_id: oxioData.line_id,
                        data_allowance: oxioData.data_allowance,
                        validity_days: oxioData.validity_days,
                        regions: oxioData.regions
                    });

                    container.innerHTML = `
                        <div class="address-card p-3 mb-3">
                            <div class="address-content">
                                <!-- Header with Service Status -->
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <div>
                                        <h4><i class="fas fa-signal me-2"></i>Wireless Service Details</h4>
                                        <span class="badge" style="background-color: ${statusColor}; color: white; font-size: 0.9em;">
                                            ${formatOxioStatus(oxioData.status)}
                                        </span>
                                    </div>
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-sm btn-outline-primary" onclick="downloadEsimDetails(${esimDetailsJson.replace(/"/g, '&quot;')})">
                                            <i class="fas fa-download"></i> Download
                                        </button>
                                        <button class="btn btn-sm btn-outline-info" onclick="emailEsimDetails(${esimDetailsJson.replace(/"/g, '&quot;')})">
                                            <i class="fas fa-envelope"></i> Email
                                        </button>
                                        <button class="btn btn-sm btn-outline-success" onclick="showEsimQRCode('${oxioData.qr_code || oxioData.activation_code}', '${oxioData.iccid}')">
                                            <i class="fas fa-qrcode"></i> QR Code
                                        </button>
                                    </div>
                                </div>

                                <div class="row">
                                    <!-- Account & Group Information -->
                                    <div class="col-md-6">
                                        <h5><i class="fas fa-users me-2"></i>Account & Group Information</h5>
                                        <div class="info-grid">
                                            <p><strong>OXIO User ID:</strong><br>
                                                <span class="text-break font-monospace">${oxioData.oxio_user_id}</span>
                                                ${createCopyButton(oxioData.oxio_user_id, 'OXIO User ID')}
                                            </p>
                                            <p><strong>OXIO Group ID:</strong><br>
                                                <span class="text-break font-monospace">${oxioData.oxio_group_id || 'Not assigned'}</span>
                                                ${createCopyButton(oxioData.oxio_group_id, 'OXIO Group ID')}
                                            </p>
                                            <p><strong>DOT User ID:</strong><br>
                                                <span class="text-break">${oxioData.user_id}</span>
                                                ${createCopyButton(oxioData.user_id, 'DOT User ID')}
                                            </p>
                                            <p><strong>Email Address:</strong><br>
                                                <span class="text-break">${oxioData.email}</span>
                                                ${createCopyButton(oxioData.email, 'Email')}
                                            </p>
                                        </div>
                                    </div>

                                    <!-- Line & Service Information -->
                                    <div class="col-md-6">
                                        <h5><i class="fas fa-phone me-2"></i>Line & Service Information</h5>
                                        <div class="info-grid">
                                            <p><strong>Phone Number:</strong><br>
                                                <span class="text-break font-weight-bold text-success">${oxioData.phone_number ? parsePhoneNumberInfo(oxioData.phone_number).formatted : 'Not assigned'}</span>
                                                ${createCopyButton(oxioData.phone_number, 'Phone Number')}
                                                ${oxioData.phone_number && parsePhoneNumberInfo(oxioData.phone_number).areaCode ? `
                                                <br><small class="text-muted">
                                                    <i class="fas fa-map-marker-alt me-1"></i>
                                                    Area ${parsePhoneNumberInfo(oxioData.phone_number).areaCode}: ${parsePhoneNumberInfo(oxioData.phone_number).areaInfo}
                                                </small>` : ''}
                                            </p>
                                            <p><strong>Line ID:</strong><br>
                                                <span class="text-break font-monospace">${oxioData.line_id || 'Not assigned'}</span>
                                                ${createCopyButton(oxioData.line_id, 'Line ID')}
                                            </p>
                                            <p><strong>Plan Name:</strong><br>
                                                <span>${oxioData.plan_name || 'Not assigned'}</span>
                                            </p>
                                            <p><strong>Data Allowance:</strong><br>
                                                <span class="text-primary font-weight-bold">${oxioData.data_allowance || 'Not specified'}</span>
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                <!-- eSIM Technical Details -->
                                <div class="row mt-4">
                                    <div class="col-12">
                                        <h5><i class="fas fa-sim-card me-2"></i>eSIM Technical Details</h5>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <p><strong>ICCID:</strong><br>
                                                    <span class="text-break font-monospace bg-light p-2 rounded d-inline-block">${oxioData.iccid || 'Not assigned'}</span>
                                                    ${createCopyButton(oxioData.iccid, 'ICCID')}
                                                </p>
                                                <p><strong>Activation Code:</strong><br>
                                                    <span class="text-break font-monospace bg-light p-2 rounded d-inline-block">${oxioData.activation_code || 'Not assigned'}</span>
                                                    ${createCopyButton(oxioData.activation_code, 'Activation Code')}
                                                </p>
                                            </div>
                                            <div class="col-md-6">
                                                <p><strong>Profile ID:</strong><br>
                                                    <span class="text-break font-monospace">${oxioData.profile_id || 'Not assigned'}</span>
                                                    ${createCopyButton(oxioData.profile_id, 'Profile ID')}
                                                </p>
                                                <p><strong>Coverage Regions:</strong><br>
                                                    <span class="badge badge-secondary me-1">${regionsText}</span>
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Service Management Actions -->
                                <div class="row mt-4">
                                    <div class="col-12">
                                        <h5><i class="fas fa-cogs me-2"></i>Service Management</h5>
                                        <div class="d-flex flex-wrap gap-2">
                                            <button class="btn btn-outline-warning" onclick="initiateSIMSwap('${oxioData.line_id}', '${oxioData.oxio_user_id}')">
                                                <i class="fas fa-exchange-alt"></i> SIM Swap
                                            </button>
                                            <button class="btn btn-outline-secondary" onclick="refreshOxioData()">
                                                <i class="fas fa-sync"></i> Refresh Status
                                            </button>
                                            <button class="btn btn-outline-info" onclick="viewServiceHistory('${oxioData.line_id}')">
                                                <i class="fas fa-history"></i> Service History
                                            </button>
                                            <button class="btn btn-outline-primary" onclick="manageDataUsage('${oxioData.line_id}')">
                                                <i class="fas fa-chart-bar"></i> Data Usage
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Service Metadata -->
                                <div class="row mt-3">
                                    <div class="col-12">
                                        <small class="text-muted">
                                            <i class="fas fa-clock me-1"></i>
                                            Last Updated: ${oxioData.last_updated ? new Date(oxioData.last_updated).toLocaleString() : 'Just now'}
                                            ${oxioData.validity_days ? `| Valid for: ${oxioData.validity_days} days` : ''}
                                        </small>
                                    </div>
                                </div>

                                ${oxioData.error ? `
                                    <div class="alert alert-info mt-3" role="alert">
                                        <strong>Info:</strong> ${oxioData.error}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }
            } else {
                displayOxioError(data.error);
            }
        }

        function displayNoOxioData() {
            const container = document.getElementById('oxioContainer');
            container.innerHTML = `
                <div class="address-card p-3 mb-3" style="border-left: 4px solid #6c757d;">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="address-content">
                            <h4>No OXIO Data Available</h4>
                            <p>Please sign in to view your OXIO information.</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function displayOxioError(error) {
            const container = document.getElementById('oxioContainer');

            // Check if this is a "user not created" error or status indicates missing OXIO user
            if ((error && error.includes('OXIO user not created')) ||
                (error && error.includes('oxio_user_not_created'))) {
                container.innerHTML = `
                    <div class="address-card p-3 mb-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="address-content">
                                <h5><i class="fas fa-info-circle me-2 text-info"></i>OXIO User Setup Required</h5>
                                <p>Your OXIO user account needs to be created first. This will enable eSIM services and mobile connectivity.</p>
                                <div class="alert alert-warning mt-2" role="alert">
                                    <small><i class="fas fa-exclamation-triangle"></i> MetaMask address was found in OXIO field - this has been corrected.</small>
                                </div>
                                <div class="d-flex gap-2 mt-3">
                                    <button class="btn btn-sm btn-success" onclick="createOxioUser()">
                                        <i class="fas fa-plus"></i> Create OXIO User
                                    </button>
                                    <button class="btn btn-sm btn-secondary" onclick="refreshOxioData()">
                                        <i class="fas fa-sync"></i> Check Status
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="address-card p-3 mb-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="address-content">
                                <h5><i class="fas fa-exclamation-triangle me-2 text-danger"></i>OXIO Service Error</h5>
                                <p>Unable to load OXIO information: ${error || 'Unknown error'}</p>
                                <button class="btn btn-sm btn-primary" onclick="refreshOxioData()">
                                    <i class="fas fa-redo"></i> Retry
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        function getOxioStatusColor(status) {
            switch(status) {
                case 'active':
                    return '#28a745';
                case 'pending':
                    return '#ffc107';
                case 'esim_ready':
                    return '#17a2b8';
                case 'ready_for_activation':
                    return '#17a2b8';
                case 'not_activated':
                    return '#6c757d';
                case 'oxio_unavailable':
                case 'oxio_error':
                case 'oxio_api_error':
                    return '#dc3545';
                default:
                    return '#6c757d';
            }
        }

        function formatOxioStatus(status) {
            switch(status) {
                case 'active':
                    return 'Active & Connected';
                case 'pending':
                    return 'Activation Pending';
                case 'esim_ready':
                    return 'eSIM Ready';
                case 'ready_for_activation':
                    return 'Ready for Line Activation';
                case 'not_activated':
                    return 'Not Activated';
                case 'oxio_unavailable':
                    return 'Service Unavailable';
                case 'oxio_error':
                case 'oxio_api_error':
                    return 'Service Error';
                default:
                    return status.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
            }
        }

        function refreshOxioData() {
            const container = document.getElementById('oxioContainer');
            container.innerHTML = `
                <div class="address-card p-3 mb-3">
                    <div class="d-flex justify-content-center align-items-center" style="min-height: 100px;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <span class="ms-3">Refreshing OXIO data...</span>
                    </div>
                </div>
            `;

            // Get current Firebase UID and reload OXIO data
            if (typeof firebase !== 'undefined' && firebase.auth && firebase.auth().currentUser) {
                const firebaseUid = firebase.auth().currentUser.uid;
                console.log('Refreshing OXIO data for Firebase UID:', firebaseUid);
                loadOxioDataWithUID(firebaseUid);
            } else {
                console.log('No Firebase user available for refresh');
                loadOxioData();
            }
        }

        function copyToClipboard(text, label) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(function() {
                    // Create a temporary toast notification
                    const toast = document.createElement('div');
                    toast.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #28a745;
                        color: white;
                        padding: 10px 15px;
                        border-radius: 5px;
                        z-index: 10000;
                        font-size: 14px;
                    `;
                    toast.textContent = `${label} copied to clipboard!`;
                    document.body.appendChild(toast);

                    setTimeout(() => {
                        toast.remove();
                    }, 2000);
                }).catch(function() {
                    fallbackCopyTextToClipboard(text, label);
                });
            } else {
                fallbackCopyTextToClipboard(text, label);
            }
        }

        function fallbackCopyTextToClipboard(text, label) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    const toast = document.createElement('div');
                    toast.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #28a745;
                        color: white;
                        padding: 10px 15px;
                        border-radius: 5px;
                        z-index: 10000;
                        font-size: 14px;
                    `;
                    toast.textContent = `${label} copied to clipboard!`;
                    document.body.appendChild(toast);

                    setTimeout(() => {
                        toast.remove();
                    }, 2000);
                } else {
                    alert(`Please manually copy: ${text}`);
                }
            } catch (err) {
                alert(`Please manually copy: ${text}`);
            }

            document.body.removeChild(textArea);
        }

        function createOxioUser() {
            const container = document.getElementById('oxioContainer');
            container.innerHTML = `
                <div class="address-card p-3 mb-3">
                    <div class="d-flex justify-content-center align-items-center" style="min-height: 100px;">
                        <div class="spinner-border text-success" role="status">
                            <span class="visually-hidden">Creating...</span>
                        </div>
                        <span class="ms-3">Creating OXIO user...</span>
                    </div>
                </div>
            `;

            // Get Firebase UID from auth state
            if (!firebase.auth().currentUser) {
                displayOxioError('No user authentication found');
                return;
            }

            const firebaseUid = firebase.auth().currentUser.uid;

            fetch('/api/create-oxio-user', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    firebaseUid: firebaseUid
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Success - reload OXIO data
                    setTimeout(() => {
                        loadOxioData();
                    }, 1000);
                } else {
                    displayOxioError(data.message || 'Failed to create OXIO user');
                }
            })
            .catch(error => {
                console.error('Error creating OXIO user:', error);
                displayOxioError(error.message);
            });
        }

        function showQRCode(qrData, title) {
            try {
                // Create modal for QR code display
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.8);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                `;

                modal.innerHTML = `
                    <div style="background: white; padding: 20px; border-radius: 10px; text-align: center; max-width: 90%; max-height: 90%; overflow: auto;">
                        <h4 style="color: #333;">eSIM Activation QR Code</h4>
                        <div id="qrCodeDisplay"></div>
                        <p style="margin: 10px 0; font-family: monospace; word-break: break-all; color: #666; font-size: 12px;">${qrData || 'No QR data available'}</p>
                        <button onclick="this.closest('div').parentElement.remove()" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 10px;">Close</button>
                    </div>
                `;

                document.body.appendChild(modal);

                // Generate QR code if QRCode library is available
                if (typeof QRCode !== 'undefined' && qrData) {
                    try {
                        new QRCode(document.getElementById("qrCodeDisplay"), {
                            text: qrData,
                            width: 200,
                            height: 200,
                            colorDark: "#000000",
                            colorLight: "#ffffff",
                            correctLevel: QRCode.CorrectLevel.H
                        });
                    } catch (qrError) {
                        console.error('Error generating QR code:', qrError);
                        document.getElementById("qrCodeDisplay").innerHTML = '<p style="color: #666;">QR code generation failed</p>';
                    }
                } else {
                    document.getElementById("qrCodeDisplay").innerHTML = '<p style="color: #666;">QR code library not available</p>';
                }

                // Close modal when clicking outside
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            } catch (error) {
                console.error('Error showing QR code:', error);
                alert('Error displaying QR code');
            }
        }

        function showEsimQRCode(qrData, iccid) {
            try {
                const modal = document.createElement('div');
                modal.className = 'esim-qr-modal';

                modal.innerHTML = `
                    <div class="esim-qr-content">
                        <h3><i class="fas fa-qrcode me-2"></i>eSIM Activation QR Code</h3>
                        <p class="text-muted mb-3">Scan this QR code with your device to install the eSIM</p>

                        <div id="esimQrCodeDisplay" class="mb-3"></div>

                        <div class="mb-3">
                            <strong>ICCID:</strong> <span class="font-monospace">${iccid || 'Not available'}</span>
                        </div>

                        <div class="mb-3">
                            <small class="text-muted font-monospace" style="word-break: break-all;">${qrData || 'No QR data available'}</small>
                        </div>

                        <div class="d-flex justify-content-center gap-2">
                            <button onclick="copyToClipboard('${qrData}', 'QR Code Data')" class="btn btn-outline-primary">
                                <i class="fas fa-copy"></i> Copy Data
                            </button>
                            <button onclick="downloadQRCode('${qrData}', '${iccid}')" class="btn btn-outline-success">
                                <i class="fas fa-download"></i> Download QR
                            </button>
                            <button onclick="this.closest('.esim-qr-modal').remove()" class="btn btn-primary">
                                <i class="fas fa-times"></i> Close
                            </button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

                // Generate QR code
                if (typeof QRCode !== 'undefined' && qrData) {
                    try {
                        new QRCode(document.getElementById("esimQrCodeDisplay"), {
                            text: qrData,
                            width: 250,
                            height: 250,
                            colorDark: "#000000",
                            colorLight: "#ffffff",
                            correctLevel: QRCode.CorrectLevel.H
                        });
                    } catch (qrError) {
                        document.getElementById("esimQrCodeDisplay").innerHTML = '<p class="text-danger">QR code generation failed</p>';
                    }
                } else {
                    document.getElementById("esimQrCodeDisplay").innerHTML = '<p class="text-warning">QR code library not available</p>';
                }

                // Close modal when clicking background
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            } catch (error) {
                console.error('Error showing eSIM QR code:', error);
                alert('Error displaying QR code');
            }
        }

        function downloadEsimDetails(esimData) {
            try {
                const dataToDownload = {
                    ...esimData,
                    download_date: new Date().toISOString(),
                    service: 'DOT Wireless - OXIO eSIM'
                };

                // Create downloadable text content
                let content = "=== DOT Wireless eSIM Configuration ===\n\n";
                content += `Download Date: ${new Date().toLocaleString()}\n\n`;
                content += `ICCID: ${esimData.iccid || 'Not available'}\n`;
                content += `Activation Code: ${esimData.activation_code || 'Not available'}\n`;
                content += `QR Code Data: ${esimData.qr_code || 'Not available'}\n`;
                content += `Profile ID: ${esimData.profile_id || 'Not available'}\n`;
                content += `Phone Number: ${esimData.phone_number || 'Not assigned'}\n`;
                content += `Line ID: ${esimData.line_id || 'Not assigned'}\n`;
                content += `Plan: ${esimData.plan_name || 'Not specified'}\n`;
                content += `Data Allowance: ${esimData.data_allowance || 'Not specified'}\n`;
                content += `Validity: ${esimData.validity_days ? esimData.validity_days + ' days' : 'Unlimited'}\n`;
                content += `Coverage: ${esimData.regions ? esimData.regions.join(', ') : 'Not specified'}\n\n`;
                content += "=== Installation Instructions ===\n";
                content += "1. Go to Settings > Cellular/Mobile Data\n";
                content += "2. Select 'Add Cellular Plan' or 'Add eSIM'\n";
                content += "3. Scan the QR code or enter the activation code manually\n";
                content += "4. Follow the on-screen setup instructions\n\n";
                content += "For support, contact DOT Wireless customer service.\n";

                const blob = new Blob([content], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `DOT-eSIM-${esimData.iccid || 'config'}-${new Date().toISOString().split('T')[0]}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                // Show success message
                showToast('eSIM configuration downloaded successfully', 'success');
            } catch (error) {
                console.error('Error downloading eSIM details:', error);
                showToast('Error downloading eSIM configuration', 'error');
            }
        }

        function emailEsimDetails(esimData) {
            try {
                // Get current user email
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                const userEmail = currentUser.email || 'user@example.com';

                const subject = `DOT Wireless - Your eSIM Configuration (ICCID: ${esimData.iccid || 'N/A'})`;
                const body = `Dear Customer,\n\nHere are your DOT Wireless eSIM configuration details:\n\n` +
                           `ICCID: ${esimData.iccid || 'Not available'}\n` +
                           `Activation Code: ${esimData.activation_code || 'Not available'}\n` +
                           `QR Code Data: ${esimData.qr_code || 'Not available'}\n` +
                           `Profile ID: ${esimData.profile_id || 'Not available'}\n` +
                           `Phone Number: ${esimData.phone_number || 'Not assigned'}\n` +
                           `Line ID: ${esimData.line_id || 'Not assigned'}\n` +
                           `Plan: ${esimData.plan_name || 'Not specified'}\n` +
                           `Data Allowance: ${esimData.data_allowance || 'Not specified'}\n` +
                           `Validity: ${esimData.validity_days ? esimData.validity_days + ' days' : 'Unlimited'}\n` +
                           `Coverage: ${esimData.regions ? esimData.regions.join(', ') : 'Not specified'}\n\n` +
                           `Installation Instructions:\n` +
                           `1. Go to Settings > Cellular/Mobile Data\n` +
                           `2. Select 'Add Cellular Plan' or 'Add eSIM'\n` +
                           `3. Scan the QR code or enter the activation code manually\n` +
                           `4. Follow the on-screen setup instructions\n\n` +
                           `For support, contact DOT Wireless customer service.\n\n` +
                           `Best regards,\nDOT Wireless Team`;

                // Create mailto link
                const mailtoLink = `mailto:${userEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;

                // Try to open mail client
                window.location.href = mailtoLink;

                showToast('Email client opened with eSIM details', 'info');
            } catch (error) {
                console.error('Error preparing email:', error);
                showToast('Error preparing email', 'error');
            }
        }

        function downloadQRCode(qrData, iccid) {
            try {
                // Create a canvas to generate QR code image
                const canvas = document.createElement('canvas');
                const qr = new QRCode(canvas, {
                    text: qrData,
                    width: 400,
                    height: 400,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });

                // Wait a moment for QR code generation
                setTimeout(() => {
                    try {
                        const qrCanvas = canvas.querySelector('canvas');
                        if (qrCanvas) {
                            const link = document.createElement('a');
                            link.download = `DOT-eSIM-QR-${iccid || 'code'}.png`;
                            link.href = qrCanvas.toDataURL();
                            link.click();
                            showToast('QR code downloaded successfully', 'success');
                        } else {
                            throw new Error('QR code canvas not found');
                        }
                    } catch (downloadError) {
                        console.error('Error downloading QR code:', downloadError);
                        showToast('Error downloading QR code', 'error');
                    }
                }, 1000);
            } catch (error) {
                console.error('Error generating QR code for download:', error);
                showToast('Error generating QR code', 'error');
            }
        }

        function initiateSIMSwap(lineId, oxioUserId) {
            if (confirm('Are you sure you want to initiate a SIM swap? This will deactivate your current eSIM and require activation of a new one.')) {
                showToast('SIM swap functionality will be available soon', 'info');

                // TODO: Implement actual SIM swap API call
                console.log('SIM swap requested for:', { lineId, oxioUserId });

                // Placeholder for future implementation
                setTimeout(() => {
                    showToast('SIM swap request submitted. You will receive further instructions via email.', 'success');
                }, 2000);
            }
        }

        function viewServiceHistory(lineId) {
            showToast('Service history functionality will be available soon', 'info');

            // TODO: Implement service history display
            console.log('Service history requested for line:', lineId);
        }

        function manageDataUsage(lineId) {
            // Redirect to dashboard data usage section
            window.location.href = '/dashboard#data-usage';
        }

        function copyFirebaseUID() {
            const firebaseUID = document.getElementById('firebaseUID').textContent;
            copyToClipboard(firebaseUID, 'Firebase UID');
        }

        function copyDotUserID() {
            const dotUserID = document.getElementById('dotUserID').textContent;
            copyToClipboard(dotUserID, 'DOT User ID');
        }

        function copyOxioUserID() {
            const oxioUserID = document.getElementById('oxioUserID').textContent;
            copyToClipboard(oxioUserID, 'OXIO User ID');
        }

        function copyOxioGroupID() {
            const oxioGroupID = document.getElementById('oxioGroupID').textContent;
            copyToClipboard(oxioGroupID, 'OXIO Group ID');
        }

        function copyAssignedICCID() {
            const iccid = document.getElementById('assignedICCID').textContent;
            copyToClipboard(iccid, 'ICCID');
        }

        function copyLPACode() {
            const lpaCode = document.getElementById('lpaCode').textContent;
            copyToClipboard(lpaCode, 'LPA Code');
        }

        async function loadAssignedICCID() {
            // This function is deprecated - eSIM data is now loaded by loadESIMDetails()
            console.log('loadAssignedICCID() is deprecated, use loadESIMDetails() instead');
            return;
        }

        function displayICCIDData(iccidData) {
            // Show ICCID section, hide no-data message
            document.getElementById('iccidSection').style.display = 'block';
            document.getElementById('noICCIDMessage').style.display = 'none';

            // Update ICCID details
            document.getElementById('assignedICCID').textContent = iccidData.iccid || '-';
            document.getElementById('iccidCountry').textContent = iccidData.country || '-';
            document.getElementById('lpaCode').textContent = iccidData.lpa_code || '-';

            // Update status badge
            const statusBadge = document.getElementById('iccidStatus');
            statusBadge.textContent = (iccidData.status || 'unknown').toUpperCase();
            statusBadge.className = `badge ${getStatusBadgeClass(iccidData.status)}`;

            // Display QR code if available
            if (iccidData.qr_codes && iccidData.qr_codes.svg && iccidData.qr_codes.svg.success) {
                const qrContainer = document.getElementById('qrCodeSVG');
                // Display inline SVG QR code
                qrContainer.innerHTML = iccidData.qr_codes.svg.data;

                // Show download button if PNG is available
                if (iccidData.qr_codes.png && iccidData.qr_codes.png.success) {
                    document.getElementById('downloadQRBtn').style.display = 'inline-block';
                    // Store PNG base64 data for download
                    window.qrCodePngData = iccidData.qr_codes.png.data;
                }
            } else {
                document.getElementById('qrCodeSVG').innerHTML = '<p class="text-muted">QR code not available</p>';
            }
        }

        function getStatusBadgeClass(status) {
            switch(status) {
                case 'available':
                    return 'bg-success';
                case 'assigned':
                    return 'bg-info';
                case 'activated':
                    return 'bg-primary';
                case 'provisioned':
                    return 'bg-warning';
                default:
                    return 'bg-secondary';
            }
        }

        function downloadQRCode() {
            if (window.qrCodePngData) {
                const link = document.createElement('a');
                link.href = window.qrCodePngData;
                link.download = 'esim-activation-qr.png';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 5px;
                color: white;
                font-weight: bold;
                z-index: 10001;
                max-width: 300px;
                word-wrap: break-word;
            `;

            // Set background color based on type
            const colors = {
                'success': '#28a745',
                'error': '#dc3545',
                'warning': '#ffc107',
                'info': '#17a2b8'
            };
            toast.style.backgroundColor = colors[type] || colors.info;

            toast.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: white; font-size: 18px; cursor: pointer; margin-left: 10px;">&times;</button>
                </div>
            `;

            document.body.appendChild(toast);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 5000);
        }

        function loadSubscriptionData() {
            // This function is kept for backward compatibility but will use the new one
            loadSubscriptionDataWithUID(null);
        }

        function loadSubscriptionDataWithUID(firebaseUid) {
            try {
                console.log('Loading subscription data with Firebase UID:', firebaseUid);

                // If no UID provided, try to get it from auth state
                if (!firebaseUid && typeof firebase !== 'undefined' && firebase.auth && firebase.auth().currentUser) {
                    firebaseUid = firebase.auth().currentUser.uid;
                    console.log('Retrieved Firebase UID from auth state:', firebaseUid);
                }

                if (!firebaseUid) {
                    console.log('No Firebase UID available for subscription data');
                    displayNoSubscription();
                    return;
                }

                // Also try to get userId from localStorage as fallback
                const currentUserData = JSON.parse(localStorage.getItem('currentUser') || 'null');
                const userId = currentUserData ? currentUserData.userId : null;

                // Build query parameters
                let queryParams = new URLSearchParams();
                queryParams.append('firebaseUid', firebaseUid);
                if (userId) {
                    queryParams.append('userId', userId);
                }

                fetch(`/api/subscription-status?${queryParams.toString()}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Subscription data loaded successfully:', data);
                        displaySubscriptionData(data);
                    })
                    .catch(error => {
                        console.error('Error loading subscription data:', error);
                        displayNoSubscription();
                    });
            } catch (error) {
                console.error('Error in loadSubscriptionDataWithUID:', error);
                displayNoSubscription();
            }
        }

        function displaySubscriptionData(data) {
            const container = document.getElementById('subscriptionContainer');

            if (data.status === 'active') {
                const subscriptionName = getSubscriptionDisplayName(data.subscription_type);
                const price = getSubscriptionPrice(data.subscription_type);
                const endDate = new Date(data.end_date).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });

                container.innerHTML = `
                    <div class="address-card p-3 mb-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="address-content">
                                <h4>${subscriptionName}</h4>
                                <p>${price}</p>
                                <p class="text-success">Active until ${endDate}</p>
                            </div>
                            <i class="fas fa-edit edit-icon" onclick="editSubscription(this)"></i>
                        </div>
                    </div>
                `;
            } else if (data.status === 'expired') {
                const subscriptionName = getSubscriptionDisplayName(data.last_subscription_type);
                const expiredDate = new Date(data.expired_date).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });

                container.innerHTML = `
                    <div class="address-card p-3 mb-3" style="border-left: 4px solid #dc3545;">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="address-content">
                                <h4>${subscriptionName}</h4>
                                <p class="text-danger">Expired on ${expiredDate}</p>
                                <p><a href="/marketplace" class="btn btn-primary btn-sm">Renew Subscription</a></p>
                            </div>
                            <i class="fas fa-edit edit-icon" onclick="editSubscription(this)"></i>
                        </div>
                    </div>
                `;
            } else {
                displayNoSubscription();
            }
        }

        function displayNoSubscription() {
            const container = document.getElementById('subscriptionContainer');
            container.innerHTML = `
                <div class="address-card p-3 mb-3" style="border-left: 4px solid #6c757d;">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="address-content">
                            <h4>No Active Subscription</h4>
                            <p>You don't have any active subscriptions</p>
                            <p><a href="/marketplace" class="btn btn-primary btn-sm">Browse Plans</a></p>
                        </div>
                    </div>
                </div>
            `;
        }

        function getSubscriptionDisplayName(subscriptionType) {
            switch(subscriptionType) {
                case 'basic_membership':
                    return 'Basic Membership';
                case 'full_membership':
                    return 'Full Membership';
                default:
                    return 'Subscription';
            }
        }

        function getSubscriptionPrice(subscriptionType) {
            switch(subscriptionType) {
                case 'basic_membership':
                    return '$24/Year';
                case 'full_membership':
                    return '$66/Year';
                default:
                    return 'Contact Support';
            }
        }

        function editAddress(element) {
            // For now, just show an alert - you can implement actual editing later
            alert('Address editing feature coming soon!');
        }

        function editSubscription(element) {
            // Navigate to marketplace for subscription management
            window.location.href = '/marketplace';
        }

        function loadBetaPhoneNumbers(firebaseUid) {
            if (!firebaseUid) {
                console.log('No Firebase UID provided for beta phone numbers');
                displayBetaAccessInfo('Authentication required to check beta phone numbers.');
                return;
            }

            try {
                console.log('Loading beta phone numbers for UID:', firebaseUid);

                fetch(`/api/user-phone-numbers?firebase_uid=${encodeURIComponent(firebaseUid)}`)
                    .then(response => {
                        if (!response.ok) {
                            // If 403, it means the user is not authorized for beta phone numbers
                            if (response.status === 403) {
                                console.log('User not authorized for beta phone numbers.');
                                displayBetaAccessInfo('You do not have access to beta phone numbers.');
                                return null; // Indicate no data to process
                            }
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data && data.success && data.phone_numbers && data.phone_numbers.length > 0) {
                            console.log('Beta phone numbers loaded successfully:', data);
                            displayBetaPhoneNumbers(data.phone_numbers);
                        } else {
                            console.log('No active beta phone numbers found for the user.');
                            // Check if user has requested beta access but it's pending or rejected
                            checkBetaRequestStatus(firebaseUid);
                        }
                    })
                    .catch(error => {
                        console.error('Error loading beta phone numbers:', error);
                        // If fetching fails, assume no access or an error occurred
                        displayBetaAccessInfo('Error checking beta phone number status.');
                    });
            } catch (error) {
                console.error('Exception in loadBetaPhoneNumbers:', error);
                displayBetaAccessInfo('An unexpected error occurred.');
            }
        }

        function checkBetaRequestStatus(firebaseUid) {
            fetch(`/api/beta-request-status?firebase_uid=${encodeURIComponent(firebaseUid)}`)
                .then(response => response.json())
                .then(data => {
                    console.log('Beta request status:', data);
                    if (data.has_request) {
                        if (data.status === 'pending') {
                            displayBetaPendingStatus();
                        } else if (data.status === 'rejected') {
                            displayBetaRejectedStatus();
                        } else {
                            // If request exists but status is unclear or active, prompt to request again or show info
                            displayBetaAccessInfo('Your beta access is pending or already active. Contact support if you have issues.');
                        }
                    } else {
                        // No request found, prompt to request access
                        displayBetaRequestOption(firebaseUid);
                    }
                })
                .catch(error => {
                    console.error('Error checking beta request status:', error);
                    displayBetaRequestOption(firebaseUid); // Default to showing request option if status check fails
                });
        }

        function displayBetaPhoneNumbers(phoneNumbers) {
            const container = document.getElementById('betaPhoneContainer');
            if (!container) return;

            let html = '';
            phoneNumbers.forEach((phoneInfo, index) => {
                const phoneNumber = phoneInfo.phone_number;
                const phoneData = parsePhoneNumberInfo(phoneNumber);
                const qrCode = phoneInfo.qr_code;
                const lpaCode = phoneInfo.lpa_code; // Assuming LPA code is also available

                html += `
                    <div class="address-card phone-number-card p-3 mb-3" style="background: rgba(0, 255, 255, 0.1); border: 1px solid rgba(0, 255, 255, 0.3); border-radius: 8px;">
                        <div class="phone-number-header">
                            <div class="phone-number-value" style="font-size: 1.5rem; font-weight: 600;">
                                ${phoneData.formatted}
                            </div>
                            <span class="badge" style="background-color: #28a745; color: white; padding: 0.5rem 1rem; font-size: 0.9rem;">ACTIVE</span>
                        </div>
                        ${phoneData.area_code_info ? `
                            <div class="area-code-info">
                                <i class="fas fa-map-marker-alt me-1"></i>
                                ${phoneData.area_code_info}
                            </div>
                        ` : ''}
                        <div class="phone-qr-button">
                            <button type="button" class="btn btn-primary w-100" onclick="showPhoneNumberPopup('${phoneData.formatted}', '${phoneData.areaCode || ''}', '${phoneData.areaInfo || ''}', '${qrCode || ''}', '${lpaCode || ''}')" style="padding: 0.75rem; font-size: 1rem;">
                                <i class="fas fa-info-circle me-2"></i> View Phone Number Options
                            </button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function displayBetaAccessInfo(message) {
            const container = document.getElementById('betaPhoneContainer');
            if (!container) return;

            container.innerHTML = `
                <div class="address-card p-3 mb-3" style="text-align: center; color: #CCCCFF; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px;">
                    <p style="margin-bottom: 0;"><i class="fas fa-info-circle me-2"></i> ${message}</p>
                    <p style="margin-top: 15px; margin-bottom: 0;">
                        <a href="/buy/esim" class="btn btn-outline-primary btn-sm">Get eSIM Beta Access</a>
                    </p>
                </div>
            `;
        }

        function displayBetaPendingStatus() {
            const container = document.getElementById('betaPhoneContainer');
            if (!container) return;

            container.innerHTML = `
                <div class="address-card p-3 mb-3" style="border-left: 4px solid #ff9800;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="address-content">
                            <h4><i class="fas fa-clock"></i> Beta Request Pending</h4>
                            <p>Your beta access request is under review. We'll notify you via email once approved.</p>
                            <p class="text-muted">Processing typically takes 1-2 business days.</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function displayBetaRejectedStatus() {
            const container = document.getElementById('betaPhoneContainer');
            if (!container) return;

            container.innerHTML = `
                <div class="address-card p-3 mb-3" style="border-left: 4px solid #f44336;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="address-content">
                            <h4><i class="fas fa-times-circle"></i> Beta Request Not Approved</h4>
                            <p>Your beta access request was not approved at this time.</p>
                            <p>You can apply again in the future as we expand our beta program.</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function displayBetaRequestOption(firebaseUid) {
            const container = document.getElementById('betaPhoneContainer');
            if (!container) return;

            container.innerHTML = `
                <div class="address-card p-3 mb-3" style="border-left: 4px solid #2196F3;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="address-content">
                            <h4>Beta Access Available</h4>
                            <p>Request access to beta features and get your own phone number with OXIO activation.</p>
                            <button class="btn btn-primary btn-sm" onclick="requestBetaAccess('${firebaseUid}')">
                                <i class="fas fa-paper-plane"></i> Request Beta Access
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function requestBetaAccess(firebaseUid) {
            const currentUser = firebase.auth().currentUser;
            if (!currentUser) {
                alert('Please log in to request beta access');
                return;
            }

            const requestData = {
                email: currentUser.email,
                firebase_uid: firebaseUid,
                name: currentUser.displayName || currentUser.email.split('@')[0]
            };

            const container = document.getElementById('betaPhoneContainer');
            container.innerHTML = `
                <div class="address-card p-3 mb-3" style="text-align: center; color: #666;">
                    <p><i class="fas fa-spinner fa-spin"></i> Submitting beta request...</p>
                </div>
            `;

            fetch('/api/beta-request', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                console.log('Beta request response:', data);
                if (data.success) {
                    displayBetaPendingStatus();
                    alert('Beta access request submitted successfully! You will receive an email notification once approved.');
                } else {
                    alert('Error submitting beta request: ' + (data.error || 'Unknown error'));
                    displayBetaRequestOption(firebaseUid);
                }
            })
            .catch(error => {
                console.error('Error submitting beta request:', error);
                alert('Error submitting beta request. Please try again.');
                displayBetaRequestOption(firebaseUid);
            });
        }

        function showPhoneNumberPopup(formattedNumber, areaCode, areaInfo, carrier, lpaCode, qrCode) {
            const popup = document.getElementById('phoneNumberPopup');
            const popupContent = document.getElementById('popupContent');

            if (!popup || !popupContent) {
                console.error('Phone number popup elements not found');
                return;
            }

            popupContent.innerHTML = `
                <div style="text-align: center;">
                    <h5 style="color: var(--text-primary); margin-bottom: 1rem;">
                        <i class="fas fa-phone"></i> ${formattedNumber}
                    </h5>
                    ${areaCode ? `
                        <p style="margin-bottom: 1.5rem;">
                            <strong>Area Code:</strong> ${areaCode} (${areaInfo})
                        </p>
                    ` : ''}
                    ${qrCode ? `
                        <div style="margin-top: 20px;">
                            <h6>eSIM QR Code:</h6>
                            <img src="data:image/png;base64,${qrCode}" alt="eSIM QR Code" style="max-width: 250px; margin: 10px auto; display: block; border: 2px solid rgba(0, 255, 255, 0.3); border-radius: 8px; padding: 10px; background: white;">
                        </div>
                    ` : ''}
                    ${lpaCode ? `
                        <div style="margin-top: 20px;">
                            <h6>eSIM Activation Code (LPA):</h6>
                            <div style="background: rgba(255, 255, 255, 0.1); padding: 10px; border-radius: 5px; word-break: break-all; font-family: monospace; font-size: 0.85rem;">
                                ${lpaCode}
                            </div>
                            <button class="btn btn-sm btn-outline-secondary mt-2" onclick="copyToClipboard('${lpaCode}', 'LPA Code')">
                                <i class="fas fa-copy"></i> Copy LPA Code
                            </button>
                        </div>
                    ` : ''}
                    <div style="margin-top: 1.5rem;">
                        <button class="btn btn-outline-warning" onclick="handleChangeNumber()">
                            <i class="fas fa-exchange-alt"></i> Change Number
                        </button>
                    </div>
                </div>
            `;

            popup.style.display = 'flex';
        }

        function hidePhoneNumberPopup() {
            document.getElementById('phoneNumberPopup').style.display = 'none';
        }

        function handleChangeNumber() {
            const popupContent = document.getElementById('popupContent');
            popupContent.innerHTML = `
                <div style="text-align: center;">
                    <h5 style="color: var(--text-primary);">Change Phone Number</h5>
                    <p>We are working on this feature. It will be available soon.</p>
                    <p><strong>Coming Soon</strong></p>
                    <button class="btn btn-secondary mt-3" onclick="hidePhoneNumberPopup()">Close</button>
                </div>
            `;
        }

        function showQRCode(qrDataUrl, title) {
            const modal = document.createElement('div');
            modal.className = 'esim-qr-modal';
            modal.innerHTML = `
                <div class="esim-qr-content">
                    <h3>${title}</h3>
                    <img src="data:image/png;base64,${qrDataUrl}" alt="${title}" style="max-width: 300px; max-height: 300px;">
                    <p>Scan this QR code to add the eSIM to your device</p>
                    <button onclick="this.parentElement.parentElement.remove()"
                            class="btn btn-secondary mt-3">Close</button>
                </div>
            `;
            modal.addEventListener('click', function(e) {
                if (e.target === modal) modal.remove();
            });
            document.body.appendChild(modal);
        }

        function toggleQRCode(event) {
            event.stopPropagation();
            const popup = document.getElementById('qrCodePopup');
            const icon = document.querySelector('.qr-code-icon');
            if (popup && popup.style.display === 'block' && !popup.contains(e.target) && e.target !== icon) {
                popup.style.display = 'none';
            }
        }

        function loadBetaPhoneNumbers(firebaseUid) {
            console.log('Loading beta phone numbers for:', firebaseUid);
            if (!firebaseUid) {
                console.error('No Firebase UID provided for beta phone numbers');
                displayBetaPhoneError('Authentication required');
                return;
            }

            fetch(`/api/user-phone-numbers?firebase_uid=${encodeURIComponent(firebaseUid)}`)
                .then(response => response.json())
                .then(data => {
                    console.log('Beta phone numbers response:', data);
                    if (data.success && data.phone_numbers && data.phone_numbers.length > 0) {
                        displayBetaPhoneNumbers(data.phone_numbers);
                    } else {
                        displayBetaPhoneInfo('No active eSIM found. Purchase eSIM Beta access to get your phone number.');
                    }
                })
                .catch(error => {
                    console.error('Error loading beta phone numbers:', error);
                    displayBetaPhoneInfo('Ready to get your eSIM! Purchase Beta access to receive your phone number.');
                });
        }

        function parsePhoneNumberInfo(phoneNumber) {
            if (!phoneNumber || phoneNumber === 'Not assigned' || phoneNumber === 'Activating...') {
                return { fullNumber: phoneNumber, formatted: phoneNumber, areaCode: null, areaInfo: 'Not available', countryCode: null };
            }
            const cleaned = phoneNumber.replace(/[+\-\s\(\)]/g, '');
            if (cleaned.length >= 10) {
                let countryCode, areaCode, localNumber, areaInfo, formatted;
                if (cleaned.startsWith('1') && cleaned.length === 11) {
                    countryCode = '1'; areaCode = cleaned.slice(1, 4); localNumber = cleaned.slice(4);
                    const areaCodeInfo = {
                        '416': 'Toronto, ON (Downtown)', '647': 'Toronto, ON (Overlay)', '437': 'Toronto, ON (Overlay)',
                        '905': 'Greater Toronto Area, ON', '289': 'Greater Toronto Area, ON (Overlay)', '365': 'Greater Toronto Area, ON (Overlay)',
                        '514': 'Montreal, QC', '438': 'Montreal, QC (Overlay)',
                        '604': 'Vancouver, BC (Metro)', '778': 'Vancouver, BC (Overlay)', '236': 'Vancouver, BC (Overlay)',
                        '403': 'Calgary, AB', '587': 'Alberta (Overlay)', '780': 'Edmonton, AB', '825': 'Alberta (Overlay)',
                        '204': 'Manitoba', '431': 'Manitoba (Overlay)', '306': 'Saskatchewan', '639': 'Saskatchewan (Overlay)',
                        '902': 'Nova Scotia/PEI', '782': 'Nova Scotia/PEI (Overlay)', '506': 'New Brunswick',
                        '709': 'Newfoundland and Labrador', '879': 'Newfoundland and Labrador (Overlay)',
                        '867': 'Yukon/NWT/Nunavut',
                        '212': 'New York, NY (Manhattan)', '646': 'New York, NY (Manhattan Overlay)', '917': 'New York, NY (Manhattan Overlay)',
                        '718': 'New York, NY (Brooklyn/Queens/Bronx/Staten Island)', '347': 'New York, NY (Brooklyn/Queens/Bronx/Staten Island Overlay)', '929': 'New York, NY (Brooklyn/Queens/Bronx/Staten Island Overlay)',
                        '310': 'Los Angeles, CA (West LA/Beverly Hills/Santa Monica)', '323': 'Los Angeles, CA (Central LA)', '213': 'Los Angeles, CA (Downtown)', '424': 'Los Angeles, CA (West LA Overlay)', '747': 'Los Angeles, CA (San Fernando Valley Overlay)', '818': 'Los Angeles, CA (San Fernando Valley)',
                        '415': 'San Francisco, CA', '628': 'San Francisco, CA (Overlay)', '650': 'San Francisco Bay Area, CA (Peninsula)',
                        '408': 'San Jose, CA (Silicon Valley)', '669': 'San Jose, CA (Silicon Valley Overlay)',
                        '510': 'Oakland/Berkeley, CA (East Bay)', '341': 'Oakland/Berkeley, CA (East Bay Overlay)'
                    };
                    areaInfo = areaCodeInfo[areaCode] || `Area Code ${areaCode} (North America)`;
                    formatted = `+1 (${areaCode}) ${localNumber.slice(0,3)}-${localNumber.slice(3)}`;
                } else if (cleaned.length >= 10) {
                    countryCode = cleaned.slice(0, 2); areaCode = cleaned.slice(2, 5); localNumber = cleaned.slice(5);
                    areaInfo = `International (+${countryCode})`;
                    formatted = `+${countryCode} ${areaCode} ${localNumber}`;
                }
                return { fullNumber: phoneNumber, formatted: formatted || phoneNumber, areaCode: areaCode, areaInfo: areaInfo, countryCode: countryCode };
            }
            return { fullNumber: phoneNumber, formatted: phoneNumber, areaCode: null, areaInfo: 'Invalid format', countryCode: null };
        }

        function displayBetaPhoneNumbers(phoneNumbers) {
            const container = document.getElementById('betaPhoneContainer');
            if (!container) return;

            let html = '';
            phoneNumbers.forEach((phoneInfo, index) => {
                const phoneNumber = phoneInfo.phone_number;
                const phoneData = parsePhoneNumberInfo(phoneNumber);
                const qrCode = phoneInfo.qr_code;
                const lpaCode = phoneInfo.lpa_code;

                html += `
                    <div class="address-card phone-number-card p-3 mb-3" style="background: rgba(0, 255, 255, 0.1); border: 1px solid rgba(0, 255, 255, 0.3); border-radius: 8px;">
                        <div class="phone-number-header">
                            <div class="phone-number-value" style="font-size: 1.5rem; font-weight: 600;">
                                ${phoneData.formatted}
                            </div>
                            <span class="badge" style="background-color: #28a745; color: white; padding: 0.5rem 1rem; font-size: 0.9rem;">ACTIVE</span>
                        </div>
                        ${phoneData.area_code_info ? `
                            <div class="area-code-info">
                                <i class="fas fa-map-marker-alt me-1"></i>
                                ${phoneData.area_code_info}
                            </div>
                        ` : ''}
                        <div class="phone-qr-button">
                            <button type="button" class="btn btn-primary w-100" onclick="showPhoneNumberPopup('${phoneData.formatted}', '${phoneData.areaCode}', '${phoneData.areaInfo}', '${phoneData.carrier || 'Beta Network'}', '${lpaCode}', '${qrCode}')" style="padding: 0.75rem; font-size: 1rem;">
                                <i class="fas fa-info-circle me-2"></i> View Phone Number Options
                            </button>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function displayBetaPhoneInfo(message) {
            const container = document.getElementById('betaPhoneContainer');
            if (!container) return;
            container.innerHTML = `
                <div class="address-card p-3 mb-3" style="text-align: center; color: #CCCCFF; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px;">
                    <p style="margin-bottom: 0;"><i class="fas fa-info-circle me-2"></i> ${message}</p>
                    <p style="margin-top: 15px; margin-bottom: 0;">
                        <a href="/buy/esim" class="btn btn-outline-primary btn-sm">Get eSIM Beta Access</a>
                    </p>
                </div>
            `;
        }

        function displayBetaPhoneError(error) {
            const container = document.getElementById('betaPhoneContainer');
            if (!container) return;
            container.innerHTML = `
                <div class="address-card p-3 mb-3" style="text-align: center; color: #ff6b6b;">
                    <p>Error loading phone numbers: ${error}</p>
                </div>
            `;
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(function() { console.log('Copied to clipboard:', text); }).catch(function(err) { console.error('Could not copy text: ', err); });
        }

        function copyBetaPhoneNumber() {
             const betaPhoneNumberElement = document.getElementById('betaPhoneNumber');
             if (betaPhoneNumberElement) {
                 copyToClipboard(betaPhoneNumberElement.textContent);
             }
        }

        // Address Management Functions
        let currentBillingAddress = null;
        let currentMailingAddress = null;
        let currentBroadbandAddress = null; // Added for broadband address

        function formatAddress(address) {
            const unitStr = address.unit ? `, ${address.unit}` : '';
            return `
                <p>${address.street}${unitStr}</p>
                <p>${address.city}, ${address.province} ${address.postal}</p>
                <p>${address.country}</p>
            `;
        }

        function loadUserAddresses() {
            const firebaseUid = getFirebaseUID();
            if (!firebaseUid) return;

            fetch(`/api/user/addresses?firebaseUid=${firebaseUid}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.addresses) {
                        displayUserAddresses(data.addresses);
                    } else {
                        // If no addresses found, ensure empty states are shown
                        document.getElementById('billingAddressDisplay').style.display = 'none';
                        document.getElementById('billingAddressEmpty').style.display = 'block';
                        document.getElementById('mailingAddressDisplay').style.display = 'none';
                        document.getElementById('mailingAddressEmpty').style.display = 'block';
                        document.getElementById('broadbandAddressDisplay').style.display = 'none';
                        document.getElementById('broadbandAddressEmpty').style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Error loading user addresses:', error);
                    // Show empty states on error
                    document.getElementById('billingAddressDisplay').style.display = 'none';
                    document.getElementById('billingAddressEmpty').style.display = 'block';
                    document.getElementById('mailingAddressDisplay').style.display = 'none';
                    document.getElementById('mailingAddressEmpty').style.display = 'block';
                    document.getElementById('broadbandAddressDisplay').style.display = 'none';
                    document.getElementById('broadbandAddressEmpty').style.display = 'block';
                });
        }

        function displayUserAddresses(addresses) {
            currentBillingAddress = addresses.billing_address;
            currentMailingAddress = addresses.mailing_address;
            currentBroadbandAddress = addresses.broadband_address; // Store broadband address

            // Display billing address
            if (currentBillingAddress) {
                document.getElementById('billingAddressDisplay').style.display = 'block';
                document.getElementById('billingAddressEmpty').style.display = 'none';
                document.getElementById('billingAddressContent').innerHTML = formatAddress(currentBillingAddress);
            } else {
                document.getElementById('billingAddressDisplay').style.display = 'none';
                document.getElementById('billingAddressEmpty').style.display = 'block';
            }

            // Display mailing address
            if (currentMailingAddress) {
                document.getElementById('mailingAddressDisplay').style.display = 'block';
                document.getElementById('mailingAddressEmpty').style.display = 'none';
                document.getElementById('mailingAddressContent').innerHTML = formatAddress(currentMailingAddress);
            } else {
                document.getElementById('mailingAddressDisplay').style.display = 'none';
                document.getElementById('mailingAddressEmpty').style.display = 'block';
            }

            // Display broadband address
            if (currentBroadbandAddress) {
                document.getElementById('broadbandAddressDisplay').style.display = 'block';
                document.getElementById('broadbandAddressEmpty').style.display = 'none';
                document.getElementById('broadbandAddressContent').innerHTML = formatAddress(currentBroadbandAddress);
            } else {
                document.getElementById('broadbandAddressDisplay').style.display = 'none';
                document.getElementById('broadbandAddressEmpty').style.display = 'block';
            }
        }

        function showBillingAddressForm() {
            document.getElementById('billingAddressForm').style.display = 'block';
            document.getElementById('billingAddressEmpty').style.display = 'none';
        }

        function editBillingAddress() {
            if (currentBillingAddress) {
                document.getElementById('billingStreet').value = currentBillingAddress.street || '';
                document.getElementById('billingUnit').value = currentBillingAddress.unit || '';
                document.getElementById('billingCity').value = currentBillingAddress.city || '';
                document.getElementById('billingProvince').value = currentBillingAddress.province || '';
                document.getElementById('billingPostal').value = currentBillingAddress.postal || '';
                document.getElementById('billingCountry').value = currentBillingAddress.country || 'Canada';
            }
            document.getElementById('billingAddressDisplay').style.display = 'none';
            document.getElementById('billingAddressForm').style.display = 'block';
        }

        function cancelBillingAddressForm() {
            document.getElementById('billingAddressForm').style.display = 'none';
            if (currentBillingAddress) {
                document.getElementById('billingAddressDisplay').style.display = 'block';
            } else {
                document.getElementById('billingAddressEmpty').style.display = 'block';
            }
        }

        function saveBillingAddress() {
            const address = {
                street: document.getElementById('billingStreet').value,
                unit: document.getElementById('billingUnit').value,
                city: document.getElementById('billingCity').value,
                province: document.getElementById('billingProvince').value,
                postal: document.getElementById('billingPostal').value,
                country: document.getElementById('billingCountry').value
            };

            if (!address.street || !address.city || !address.province || !address.postal) {
                alert('Please fill in all required fields');
                return;
            }

            const firebaseUid = getFirebaseUID();
            if (!firebaseUid) {
                alert('Please sign in to save addresses');
                return;
            }

            fetch('/api/user/addresses', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    firebase_uid: firebaseUid,
                    billing_address: address,
                    mailing_address: currentMailingAddress,
                    broadband_address: currentBroadbandAddress
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentBillingAddress = address;
                    displayUserAddresses({ // Re-display all addresses to reflect the change
                        billing_address: currentBillingAddress,
                        mailing_address: currentMailingAddress,
                        broadband_address: currentBroadbandAddress
                    });
                    document.getElementById('billingAddressForm').style.display = 'none'; // Hide form
                } else {
                    alert('Error saving address: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error saving address:', error);
                alert('Error saving address');
            });
        }

        function showMailingAddressForm() {
            document.getElementById('mailingAddressForm').style.display = 'block';
            document.getElementById('mailingAddressEmpty').style.display = 'none';
        }

        function editMailingAddress() {
            if (currentMailingAddress) {
                document.getElementById('mailingStreet').value = currentMailingAddress.street || '';
                document.getElementById('mailingUnit').value = currentMailingAddress.unit || '';
                document.getElementById('mailingCity').value = currentMailingAddress.city || '';
                document.getElementById('mailingProvince').value = currentMailingAddress.province || '';
                document.getElementById('mailingPostal').value = currentMailingAddress.postal || '';
                document.getElementById('mailingCountry').value = currentMailingAddress.country || 'Canada';
            }
            document.getElementById('mailingAddressDisplay').style.display = 'none';
            document.getElementById('mailingAddressForm').style.display = 'block';
            // Ensure checkbox state is correct
            const checkbox = document.getElementById('sameAsBilling');
            if (checkbox) checkbox.checked = false;
            toggleSameAsBilling(); // Reset field states
        }

        function cancelMailingAddressForm() {
            document.getElementById('mailingAddressForm').style.display = 'none';
            if (currentMailingAddress) {
                document.getElementById('mailingAddressDisplay').style.display = 'block';
            } else {
                document.getElementById('mailingAddressEmpty').style.display = 'block';
            }
        }

        function toggleSameAsBilling() {
            const sameAsBilling = document.getElementById('sameAsBilling').checked;
            const mailingFields = ['mailingStreet', 'mailingUnit', 'mailingCity', 'mailingProvince', 'mailingPostal', 'mailingCountry'];

            if (sameAsBilling) {
                if (currentBillingAddress) {
                    document.getElementById('mailingStreet').value = currentBillingAddress.street || '';
                    document.getElementById('mailingUnit').value = currentBillingAddress.unit || '';
                    document.getElementById('mailingCity').value = currentBillingAddress.city || '';
                    document.getElementById('mailingProvince').value = currentBillingAddress.province || '';
                    document.getElementById('mailingPostal').value = currentBillingAddress.postal || '';
                    document.getElementById('mailingCountry').value = currentBillingAddress.country || 'Canada';

                    mailingFields.forEach(field => {
                        document.getElementById(field).readOnly = true;
                        document.getElementById(field).style.backgroundColor = 'rgba(200, 200, 200, 0.2)';
                    });
                } else {
                    alert('Please save a billing address first');
                    document.getElementById('sameAsBilling').checked = false;
                }
            } else {
                // Clear and enable fields if not same as billing
                mailingFields.forEach(field => {
                    document.getElementById(field).readOnly = false;
                    document.getElementById(field).style.backgroundColor = '';
                });
                // Optionally clear fields if needed, or keep user input
                // document.getElementById('mailingStreet').value = ''; ... etc.
            }
        }

        function saveMailingAddress() {
            const address = {
                street: document.getElementById('mailingStreet').value,
                unit: document.getElementById('mailingUnit').value,
                city: document.getElementById('mailingCity').value,
                province: document.getElementById('mailingProvince').value,
                postal: document.getElementById('mailingPostal').value,
                country: document.getElementById('mailingCountry').value
            };

            if (!address.street || !address.city || !address.province || !address.postal) {
                alert('Please fill in all required fields');
                return;
            }

            const firebaseUid = getFirebaseUID();
            if (!firebaseUid) {
                alert('Please sign in to save addresses');
                return;
            }

            fetch('/api/user/addresses', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    firebase_uid: firebaseUid,
                    billing_address: currentBillingAddress,
                    mailing_address: address,
                    broadband_address: currentBroadbandAddress
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentMailingAddress = address;
                    displayUserAddresses({ // Re-display all addresses to reflect the change
                        billing_address: currentBillingAddress,
                        mailing_address: currentMailingAddress,
                        broadband_address: currentBroadbandAddress
                    });
                    document.getElementById('mailingAddressForm').style.display = 'none'; // Hide form
                } else {
                    alert('Error saving address: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error saving address:', error);
                alert('Error saving address');
            });
        }

        // Broadband Address Functions
        function showBroadbandAddressForm() {
            document.getElementById('broadbandAddressEmpty').style.display = 'none';
            document.getElementById('broadbandAddressForm').style.display = 'block';
        }

        function editBroadbandAddress() {
            document.getElementById('broadbandAddressDisplay').style.display = 'none';
            document.getElementById('broadbandAddressForm').style.display = 'block';

            if (currentBroadbandAddress) {
                document.getElementById('broadbandStreet').value = currentBroadbandAddress.street || '';
                document.getElementById('broadbandUnit').value = currentBroadbandAddress.unit || '';
                document.getElementById('broadbandCity').value = currentBroadbandAddress.city || '';
                document.getElementById('broadbandProvince').value = currentBroadbandAddress.province || '';
                document.getElementById('broadbandPostal').value = currentBroadbandAddress.postal || '';
                document.getElementById('broadbandCountry').value = currentBroadbandAddress.country || 'Canada';
            }
        }

        function saveBroadbandAddress() {
            const address = {
                street: document.getElementById('broadbandStreet').value,
                unit: document.getElementById('broadbandUnit').value,
                city: document.getElementById('broadbandCity').value,
                province: document.getElementById('broadbandProvince').value,
                postal: document.getElementById('broadbandPostal').value,
                country: document.getElementById('broadbandCountry').value
            };

            if (!address.street || !address.city || !address.province || !address.postal || !address.country) {
                alert('Please fill in all required fields');
                return;
            }

            const firebaseUid = getFirebaseUID();
            if (!firebaseUid) {
                alert('Please sign in to save addresses');
                return;
            }

            fetch('/api/user/addresses', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    firebaseUid: firebaseUid,
                    billing_address: currentBillingAddress,
                    mailing_address: currentMailingAddress,
                    broadband_address: address
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentBroadbandAddress = address; // Update current broadband address
                    displayUserAddresses({ // Re-display all addresses to reflect the change
                        billing_address: currentBillingAddress,
                        mailing_address: currentMailingAddress,
                        broadband_address: currentBroadbandAddress
                    });
                    document.getElementById('broadbandAddressForm').style.display = 'none'; // Hide form
                } else {
                    alert('Error saving address: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error saving broadband address:', error);
                alert('Error saving address. Please try again.');
            });
        }

        function cancelBroadbandAddressForm() {
            document.getElementById('broadbandAddressForm').style.display = 'none';
            if (currentBroadbandAddress) {
                document.getElementById('broadbandAddressDisplay').style.display = 'block';
            } else {
                document.getElementById('broadbandAddressEmpty').style.display = 'block';
            }
        }

        function loadESIMDetails() {
            // Load Beta eSIM information from user data
            const firebaseUid = firebase.auth().currentUser?.uid;
            if (!firebaseUid) {
                console.log('No Firebase user available for eSIM details');
                return;
            }

            // Show loading state
            const loadingDiv = document.getElementById('esimLoading');
            const noDataDiv = document.getElementById('esimNoData');
            const betaEsimCard = document.getElementById('betaEsimCard');

            if (loadingDiv) loadingDiv.style.display = 'block';
            if (noDataDiv) noDataDiv.style.display = 'none';
            if (betaEsimCard) betaEsimCard.style.display = 'none';

            // Fetch user's phone numbers for Beta eSIM
            fetch(`/api/user-phone-numbers?firebase_uid=${encodeURIComponent(firebaseUid)}`)
                .then(response => response.json())
                .then(data => {
                    if (loadingDiv) loadingDiv.style.display = 'none';

                    if (data.success && data.phone_numbers && data.phone_numbers.length > 0) {
                        displayBetaEsimCard(data.phone_numbers[0]);
                    } else {
                        if (noDataDiv) noDataDiv.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Error loading eSIM details:', error);
                    if (loadingDiv) loadingDiv.style.display = 'none';
                    if (noDataDiv) noDataDiv.style.display = 'block';
                });
        }

        function displayBetaEsimCard(esimData) {
            const betaEsimCard = document.getElementById('betaEsimCard');
            if (!betaEsimCard) return;

            const phoneNumber = esimData.phone_number || 'Not assigned';
            const phoneData = parsePhoneNumberInfo(phoneNumber);
            const qrCode = esimData.qr_code || '';
            const lpaCode = esimData.lpa_code || '';
            const activatedDate = esimData.activated_at ? new Date(esimData.activated_at) : new Date();
            const formattedDate = activatedDate.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            // Create Beta eSIM card that's clickable
            betaEsimCard.innerHTML = `
                <div class="address-card phone-number-card p-3 mb-3" style="background: rgba(0, 255, 255, 0.1); border: 1px solid rgba(0, 255, 255, 0.3); border-radius: 8px; cursor: pointer;"
                     onclick="showPhoneNumberPopup('${phoneData.formatted}', '${phoneData.areaCode}', '${phoneData.areaInfo}', '${phoneData.carrier || 'Beta Network'}', '${lpaCode}', '${qrCode}')">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 style="margin: 0; color: rgba(0, 255, 255, 1);"><i class="fas fa-sim-card"></i> Beta eSIM</h6>
                            <p style="margin: 5px 0 0 0; font-size: 0.9rem; color: var(--text-secondary);">Purchased: ${formattedDate}</p>
                        </div>
                        <div>
                            <span class="badge bg-success">ACTIVE</span>
                        </div>
                    </div>
                </div>
            `;

            betaEsimCard.style.display = 'block';
        }

        function loadNetworkServicesOverview() {
            const networkServicesLoading = document.getElementById('networkServicesLoading');
            const networkServicesContent = document.getElementById('networkServicesContent');
            const networkServicesError = document.getElementById('networkServicesError');
            const activeServicesList = document.getElementById('activeServicesList');
            const noActiveServices = document.getElementById('noActiveServices');

            // Show loading indicator
            if (networkServicesLoading) networkServicesLoading.style.display = 'block';
            if (networkServicesContent) networkServicesContent.style.display = 'none';
            if (networkServicesError) networkServicesError.style.display = 'none';
            if (activeServicesList) activeServicesList.innerHTML = ''; // Clear previous content
            if (noActiveServices) noActiveServices.style.display = 'none';

            // Get current Firebase UID
            const firebaseUid = getFirebaseUID();
            if (!firebaseUid) {
                console.log('No Firebase UID available for network services overview');
                if (networkServicesLoading) networkServicesLoading.style.display = 'none';
                if (networkServicesError) {
                    networkServicesError.style.display = 'block';
                    networkServicesError.querySelector('p').textContent = 'Please log in to view network services.';
                }
                return;
            }

            // Fetch active network services
            fetch(`/api/network/services?firebaseUid=${firebaseUid}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (networkServicesLoading) networkServicesLoading.style.display = 'none';

                    if (data.success && data.services && data.services.length > 0) {
                        console.log('Network services loaded:', data.services);
                        displayActiveNetworkServices(data.services);
                        if (networkServicesContent) networkServicesContent.style.display = 'block';
                    } else if (data.success && (!data.services || data.services.length === 0)) {
                        console.log('No active network services found.');
                        if (noActiveServices) noActiveServices.style.display = 'block';
                        if (networkServicesContent) networkServicesContent.style.display = 'block';
                    } else {
                        console.error('Failed to load network services:', data.message);
                        if (networkServicesError) networkServicesError.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Error fetching network services:', error);
                    if (networkServicesLoading) networkServicesLoading.style.display = 'none';
                    if (networkServicesError) networkServicesError.style.display = 'block';
                });
        }

        function displayActiveNetworkServices(services) {
            const activeServicesList = document.getElementById('activeServicesList');
            if (!activeServicesList) return;

            let html = '';
            services.forEach(service => {
                const statusBadgeClass = getServiceStatusBadgeClass(service.status);
                html += `
                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 border-bottom" style="border-color: rgba(255, 255, 255, 0.1);">
                        <div>
                            <i class="fas ${getServiceIcon(service.type)} me-2"></i>
                            <strong>${service.name}</strong>
                            <span class="badge ms-2 ${statusBadgeClass}">${service.status.toUpperCase()}</span>
                        </div>
                        <div>
                            <small class="me-2 text-muted">Valid until: ${new Date(service.expiry_date).toLocaleDateString()}</small>
                            <a href="/network" class="btn btn-sm btn-outline-primary"><i class="fas fa-cog"></i> Manage</a>
                        </div>
                    </div>
                `;
            });
            activeServicesList.innerHTML = html;
        }

        function getServiceStatusBadgeClass(status) {
            switch(status) {
                case 'active': return 'bg-success';
                case 'pending': return 'bg-warning';
                case 'inactive': return 'bg-secondary';
                case 'error': return 'bg-danger';
                default: return 'bg-info';
            }
        }

        function getServiceIcon(serviceType) {
            switch(serviceType) {
                case 'data': return 'fa-database';
                case 'voice': return 'fa-phone';
                case 'sms': return 'fa-sms';
                case '5g': return 'fa-wave-square';
                default: return 'fa-wifi';
            }
        }

        auth.onAuthStateChanged((user) => {
            if (user) {
                setTimeout(() => { 
                    loadESIMDetails();
                    refreshOxioData();
                }, 1000);
                // Load network services overview when user is authenticated
                loadNetworkServicesOverview();
            }
        });

        document.addEventListener('click', function(e) {
            const popup = document.getElementById('qrCodePopup');
            const icon = document.querySelector('.qr-code-icon');
            if (popup && popup.style.display === 'block' && !popup.contains(e.target) && e.target !== icon) {
                popup.style.display = 'none';
            }
        });
    </script>
</body>
</html>